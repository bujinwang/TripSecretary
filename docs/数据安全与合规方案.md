# 数据安全与合规方案

> **核心问题**: 加密存储和GDPR合规

---

## 一、加密存储

### 1.1 Cloudflare D1的加密

**答：是的，支持加密！而且是自动的！**

```
Cloudflare D1的加密机制:

传输加密:
✅ TLS 1.3 (HTTPS)
✅ 所有Worker <-> D1通信都加密
✅ 自动启用，无需配置

存储加密:
✅ 静态数据加密 (Encryption at Rest)
✅ AES-256加密
✅ 自动启用，无需配置
✅ 密钥由Cloudflare管理

位置:
✅ 数据存储在欧盟（EU）或美国
✅ 可以选择区域
```

**但是！敏感数据需要应用层加密！**

---

### 1.2 应用层加密（推荐）⭐⭐⭐⭐⭐

**为什么需要应用层加密？**

```
场景：护照号、身份证号等敏感信息

只靠D1自动加密:
数据库管理员 → 可以看到明文 ❌
Cloudflare员工 → 理论上可以看到 ❌

应用层加密:
数据库管理员 → 看到的是密文 ✅
Cloudflare员工 → 看到的是密文 ✅
只有你的APP → 可以解密 ✅
```

### 1.3 实现应用层加密

#### 方案A：使用Web Crypto API（推荐）

```javascript
// /lib/encryption.js - 加密工具类

class EncryptionService {
  constructor(masterKey) {
    this.masterKey = masterKey;
  }

  // 生成加密密钥
  async getKey() {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      enc.encode(this.masterKey),
      'PBKDF2',
      false,
      ['deriveBits', 'deriveKey']
    );

    return await crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt: enc.encode('trip-secretary-salt'),
        iterations: 100000,
        hash: 'SHA-256'
      },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }

  // 加密函数
  async encrypt(plaintext) {
    const key = await this.getKey();
    const enc = new TextEncoder();
    const encoded = enc.encode(plaintext);

    // 生成随机IV
    const iv = crypto.getRandomValues(new Uint8Array(12));

    // AES-GCM加密
    const ciphertext = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      encoded
    );

    // 组合IV和密文
    const result = new Uint8Array(iv.length + ciphertext.byteLength);
    result.set(iv, 0);
    result.set(new Uint8Array(ciphertext), iv.length);

    // Base64编码
    return btoa(String.fromCharCode(...result));
  }

  // 解密函数
  async decrypt(encryptedData) {
    const key = await this.getKey();
    
    // Base64解码
    const data = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));

    // 分离IV和密文
    const iv = data.slice(0, 12);
    const ciphertext = data.slice(12);

    // AES-GCM解密
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: iv },
      key,
      ciphertext
    );

    const dec = new TextDecoder();
    return dec.decode(decrypted);
  }
}

export default EncryptionService;
```

#### 在React Native中使用

```javascript
// /app/services/secureStorage.js
import EncryptionService from './encryption';
import * as SQLite from 'expo-sqlite';

const db = SQLite.openDatabase('borderbuddy.db');
const encryption = new EncryptionService(process.env.ENCRYPTION_KEY);

// 保存加密的护照信息
export async function savePassport(passportData) {
  // 1. 加密敏感字段
  const encryptedPassportNo = await encryption.encrypt(passportData.passport_no);
  const encryptedName = await encryption.encrypt(passportData.name);

  // 2. 存入数据库（存的是密文）
  db.transaction(tx => {
    tx.executeSql(
      `INSERT INTO passports (
        encrypted_passport_no,
        encrypted_name,
        expiry
      ) VALUES (?, ?, ?)`,
      [encryptedPassportNo, encryptedName, passportData.expiry]
    );
  });
}

// 读取并解密
export async function getPassport(id) {
  return new Promise((resolve) => {
    db.transaction(tx => {
      tx.executeSql(
        'SELECT * FROM passports WHERE id = ?',
        [id],
        async (_, { rows }) => {
          const encrypted = rows._array[0];
          
          // 解密敏感字段
          const decrypted = {
            id: encrypted.id,
            passport_no: await encryption.decrypt(encrypted.encrypted_passport_no),
            name: await encryption.decrypt(encrypted.encrypted_name),
            expiry: encrypted.expiry
          };
          
          resolve(decrypted);
        }
      );
    });
  });
}
```

#### 在Cloudflare Worker中使用

```javascript
// workers/index.js
import EncryptionService from './encryption';

const encryption = new EncryptionService(env.ENCRYPTION_KEY);

export default {
  async fetch(request, env) {
    const { passportNo, name } = await request.json();

    // 加密后存入D1
    const encryptedPassportNo = await encryption.encrypt(passportNo);
    const encryptedName = await encryption.encrypt(name);

    await env.DB.prepare(
      'INSERT INTO passports (encrypted_passport_no, encrypted_name) VALUES (?, ?)'
    ).bind(encryptedPassportNo, encryptedName).run();

    // 读取时解密
    const result = await env.DB.prepare(
      'SELECT * FROM passports WHERE id = ?'
    ).bind(id).first();

    const decrypted = {
      passport_no: await encryption.decrypt(result.encrypted_passport_no),
      name: await encryption.decrypt(result.encrypted_name)
    };

    return new Response(JSON.stringify(decrypted));
  }
};
```

### 1.4 加密字段对照表

```
需要加密的敏感字段:
✅ 护照号 (passport_no)
✅ 身份证号 (id_card_no)
✅ 签证号 (visa_no)
✅ 出生日期 (date_of_birth)
✅ 详细地址 (address)

不需要加密的字段:
⭐ 用户ID (id)
⭐ 创建时间 (created_at)
⭐ 护照有效期 (expiry_date)
⭐ 国籍 (nationality)
⭐ 目的地 (destination)
```

---

## 二、GDPR合规

### 2.1 什么是GDPR？

```
GDPR = General Data Protection Regulation
（欧盟通用数据保护条例）

适用范围:
✅ 欧盟公民的数据
✅ 在欧盟境内处理的数据
✅ 向欧盟提供服务的公司

我们的APP需要合规吗？
如果有欧盟用户 → ✅ 需要
如果只有中国用户 → ⚠️ 建议遵守（最佳实践）
```

### 2.2 Cloudflare的GDPR合规

**好消息：Cloudflare完全符合GDPR！**

```
Cloudflare GDPR合规认证:
✅ ISO 27001认证
✅ SOC 2 Type II认证
✅ 数据处理协议（DPA）
✅ 标准合同条款（SCC）
✅ 欧盟代表（GDPR Article 27）

数据存储位置:
✅ 可以选择欧盟区域
✅ 数据不会离开选定区域
✅ 符合数据本地化要求
```

**Cloudflare官方声明：**
> "Cloudflare is GDPR compliant and helps customers meet their GDPR obligations."

---

### 2.3 我们需要做什么？（GDPR合规清单）

#### ✅ 1. 用户知情同意

```javascript
// 登录时显示隐私政策
function LoginScreen() {
  const [agreedToPolicy, setAgreedToPolicy] = useState(false);

  return (
    <View>
      <Checkbox
        value={agreedToPolicy}
        onValueChange={setAgreedToPolicy}
      />
      <Text>
        我已阅读并同意
        <Link href="/privacy-policy">《隐私政策》</Link>
        和
        <Link href="/terms">《用户协议》</Link>
      </Text>

      <Button
        disabled={!agreedToPolicy}
        onPress={handleLogin}
      >
        微信登录
      </Button>
    </View>
  );
}
```

**隐私政策必须包含：**
```
1. 收集哪些数据？
   - 微信昵称、头像
   - 护照信息
   - 使用记录

2. 数据用于什么？
   - 生成入境表格
   - 改进服务

3. 数据存储在哪里？
   - 本地手机（加密）
   - Cloudflare服务器（欧盟/美国）

4. 数据保存多久？
   - 账号存在期间
   - 删除账号后30天内删除

5. 第三方分享吗？
   - 不分享给第三方
   - AI服务商（通义千问）- 仅处理不存储

6. 用户权利：
   - 查看数据
   - 修改数据
   - 删除数据（被遗忘权）
   - 导出数据（数据可携权）
```

#### ✅ 2. 数据最小化原则

```javascript
// 只收集必要的数据
const userData = {
  // ✅ 必要
  wechat_openid: user.openid,
  nickname: user.nickname,
  
  // ❌ 不必要（不收集）
  // phone: user.phone,
  // email: user.email,
  // friends_list: user.friends
};
```

#### ✅ 3. 数据访问权（Right to Access）

```javascript
// /api/user/export-data
export default {
  async fetch(request, env) {
    const userId = getUserIdFromToken(request);

    // 导出用户所有数据
    const userData = await env.DB.prepare(`
      SELECT 
        u.nickname,
        u.avatar,
        u.created_at,
        p.passport_no,
        p.expiry,
        g.destination,
        g.created_at as generated_at
      FROM users u
      LEFT JOIN passports p ON p.user_id = u.id
      LEFT JOIN generation_history g ON g.user_id = u.id
      WHERE u.id = ?
    `).bind(userId).all();

    // 返回JSON格式
    return new Response(JSON.stringify(userData.results), {
      headers: {
        'Content-Type': 'application/json',
        'Content-Disposition': 'attachment; filename="my-data.json"'
      }
    });
  }
};
```

#### ✅ 4. 被遗忘权（Right to be Forgotten）

```javascript
// /api/user/delete-account
export default {
  async fetch(request, env) {
    const userId = getUserIdFromToken(request);

    // 删除所有用户数据
    await env.DB.batch([
      // 删除生成历史
      env.DB.prepare('DELETE FROM generation_history WHERE user_id = ?').bind(userId),
      
      // 删除证件
      env.DB.prepare('DELETE FROM passports WHERE user_id = ?').bind(userId),
      
      // 删除用户
      env.DB.prepare('DELETE FROM users WHERE id = ?').bind(userId)
    ]);

    // 删除R2中的文件
    await env.MY_BUCKET.delete(`passport-photos/${userId}.jpg`);

    // 记录删除日志（用于审计）
    await env.DB.prepare(
      'INSERT INTO deletion_log (user_id, deleted_at, reason) VALUES (?, ?, ?)'
    ).bind(userId, new Date().toISOString(), 'user_request').run();

    return new Response(JSON.stringify({
      success: true,
      message: '您的数据已完全删除'
    }));
  }
};
```

#### ✅ 5. 数据可携权（Right to Data Portability）

```javascript
// 提供标准格式导出
function ExportDataScreen() {
  const exportData = async () => {
    const response = await fetch('/api/user/export-data');
    const data = await response.json();

    // 保存为JSON文件
    const fileUri = FileSystem.documentDirectory + 'my-data.json';
    await FileSystem.writeAsStringAsync(fileUri, JSON.stringify(data, null, 2));

    // 或者直接分享
    await Sharing.shareAsync(fileUri);
  };

  return (
    <Button onPress={exportData}>
      导出我的数据
    </Button>
  );
}
```

#### ✅ 6. 数据泄露通知（72小时内）

```javascript
// 安全监控和告警系统
export default {
  async fetch(request, env) {
    try {
      // 正常处理
      return await handleRequest(request, env);
    } catch (error) {
      // 如果是安全事件
      if (error.code === 'SECURITY_BREACH') {
        // 立即通知
        await notifySecurityTeam(error);
        await notifyAffectedUsers(error);
        
        // 记录事件
        await logSecurityIncident({
          type: 'data_breach',
          timestamp: new Date(),
          details: error.message
        });
      }
      throw error;
    }
  }
};
```

#### ✅ 7. 数据处理记录（Article 30）

```javascript
// 维护数据处理活动记录
const dataProcessingRecord = {
  controller: {
    name: '通关助手',
    contact: 'privacy@borderbuddy.com'
  },
  
  purposes: [
    '生成入境表格',
    '存储证件信息',
    '改进服务'
  ],
  
  categories: [
    '身份数据（姓名、护照号）',
    '联系数据（微信账号）',
    '使用数据（生成历史）'
  ],
  
  recipients: [
    '阿里云（AI处理）',
    'Cloudflare（存储）'
  ],
  
  retention: '账号存续期间，删除后30天内清除',
  
  security: [
    'AES-256加密',
    'TLS 1.3传输',
    '访问控制',
    '定期安全审计'
  ]
};
```

---

### 2.4 Cloudflare区域选择（GDPR）

```javascript
// wrangler.toml - 选择欧盟区域
[env.production]
compatibility_date = "2024-01-01"

# 限制数据只在欧盟
[[env.production.d1_databases]]
binding = "DB"
database_name = "trip-secretary-eu"
database_id = "xxx"
location = "eu-west"  # 欧盟区域

# 限制KV只在欧盟
[[env.production.kv_namespaces]]
binding = "MY_KV"
id = "xxx"
preview_id = "xxx"
```

**Cloudflare支持的区域：**
```
✅ EU (欧盟)
✅ US (美国)
✅ APAC (亚太 - 新加坡等)
✅ 自动全球复制
```

---

## 三、中国数据合规

### 3.1 《个人信息保护法》（PIPL）

**中国版的GDPR，2021年11月生效**

```
核心要求（与GDPR相似）:

✅ 用户知情同意
✅ 数据最小化
✅ 目的明确
✅ 安全保护
✅ 用户权利（访问、删除、修改）

额外要求:
⚠️ 关键信息基础设施 - 数据必须存储在中国境内
⚠️ 向境外提供数据 - 需要通过安全评估

我们的APP需要吗？
如果用户 > 100万 → ✅ 可能需要评估
如果用户 < 100万 → ⚠️ 建议遵守最佳实践
```

### 3.2 本地化策略

```
方案：混合存储

敏感数据（中国用户）:
└─ 存储在本地SQLite（手机内）
   ├── 护照信息
   ├── 身份证信息
   └── 个人详细信息

非敏感数据:
└─ 存储在Cloudflare D1
   ├── 用户ID
   ├── 生成历史（不含详情）
   └── 应用设置

云端备份（可选）:
└─ 加密后存储
   └─ 即使被访问也无法解密
```

---

## 四、完整安全架构

### 4.1 多层加密保护

```
┌─────────────────────────────────────┐
│   用户手机                          │
│                                     │
│   ┌──────────────────────────────┐ │
│   │ 应用层加密                   │ │
│   │ AES-256                      │ │
│   │ 护照号: "E12..." → "k8x9..." │ │
│   └──────────────────────────────┘ │
│                                     │
│   ┌──────────────────────────────┐ │
│   │ 本地SQLite加密               │ │
│   │ SQLCipher                    │ │
│   │ 整个数据库文件加密           │ │
│   └──────────────────────────────┘ │
│                                     │
│   ┌──────────────────────────────┐ │
│   │ 手机系统加密                 │ │
│   │ iOS: Data Protection         │ │
│   │ Android: File-based          │ │
│   └──────────────────────────────┘ │
└─────────────────────────────────────┘
              │ TLS 1.3
              ↓
┌─────────────────────────────────────┐
│   Cloudflare Workers                │
│   - 内存中处理（不存储）            │
│   - HTTPS Only                      │
└─────────────────────────────────────┘
              │ TLS 1.3
              ↓
┌─────────────────────────────────────┐
│   Cloudflare D1                     │
│                                     │
│   ┌──────────────────────────────┐ │
│   │ 应用层加密数据               │ │
│   │ "k8x9..." (密文)             │ │
│   └──────────────────────────────┘ │
│                                     │
│   ┌──────────────────────────────┐ │
│   │ D1自动加密                   │ │
│   │ AES-256 at rest              │ │
│   └──────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 4.2 密钥管理

```javascript
// 密钥分层管理
const keyManagement = {
  // Level 1: 主密钥（环境变量）
  masterKey: process.env.MASTER_ENCRYPTION_KEY,
  
  // Level 2: 派生密钥（用户专属）
  deriveUserKey: async (userId, masterKey) => {
    return await crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt: new TextEncoder().encode(`user-${userId}`),
        iterations: 100000,
        hash: 'SHA-256'
      },
      await importMasterKey(masterKey),
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  },
  
  // Level 3: 字段专属密钥
  deriveFieldKey: async (userKey, fieldName) => {
    // 每个字段使用不同的密钥
    return await derivedKey(userKey, fieldName);
  }
};
```

---

## 五、安全检查清单

### 5.1 开发阶段

```
✅ 敏感字段加密
✅ HTTPS Only（禁用HTTP）
✅ API密钥环境变量（不硬编码）
✅ SQL注入防护（使用参数化查询）
✅ XSS防护
✅ CSRF防护
✅ 速率限制（防暴力破解）
✅ 输入验证
✅ 错误信息不泄露敏感信息
```

### 5.2 部署阶段

```
✅ 所有密钥使用wrangler secret
✅ 生产环境独立密钥
✅ 定期轮换密钥
✅ 访问日志记录
✅ 异常监控
✅ 备份加密
```

### 5.3 运营阶段

```
✅ 定期安全审计
✅ 依赖包漏洞扫描
✅ 用户数据定期备份
✅ 灾难恢复计划
✅ 安全事件响应流程
✅ GDPR/PIPL合规文档
```

---

## 六、实际实施代码

### 6.1 完整的安全存储示例

```javascript
// /lib/secureStorage.js
import EncryptionService from './encryption';
import * as SQLite from 'expo-sqlite';
import * as SecureStore from 'expo-secure-store';

class SecureStorage {
  constructor() {
    this.db = SQLite.openDatabase('borderbuddy.db');
    this.encryption = null;
  }

  // 初始化加密（使用用户密钥）
  async initialize(userId) {
    // 从安全存储获取或生成用户密钥
    let userKey = await SecureStore.getItemAsync(`key_${userId}`);
    
    if (!userKey) {
      // 生成新密钥
      userKey = this.generateRandomKey();
      await SecureStore.setItemAsync(`key_${userId}`, userKey);
    }
    
    this.encryption = new EncryptionService(userKey);
  }

  // 生成随机密钥
  generateRandomKey() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
  }

  // 保存护照（加密）
  async savePassport(passportData) {
    const encrypted = {
      id: passportData.id,
      encrypted_passport_no: await this.encryption.encrypt(passportData.passport_no),
      encrypted_name: await this.encryption.encrypt(passportData.name),
      encrypted_dob: await this.encryption.encrypt(passportData.date_of_birth),
      expiry: passportData.expiry, // 不敏感，不加密
      created_at: new Date().toISOString()
    };

    return new Promise((resolve, reject) => {
      this.db.transaction(tx => {
        tx.executeSql(
          `INSERT INTO passports (
            id,
            encrypted_passport_no,
            encrypted_name,
            encrypted_dob,
            expiry,
            created_at
          ) VALUES (?, ?, ?, ?, ?, ?)`,
          [
            encrypted.id,
            encrypted.encrypted_passport_no,
            encrypted.encrypted_name,
            encrypted.encrypted_dob,
            encrypted.expiry,
            encrypted.created_at
          ],
          (_, result) => resolve(result),
          (_, error) => reject(error)
        );
      });
    });
  }

  // 读取护照（解密）
  async getPassport(id) {
    return new Promise((resolve, reject) => {
      this.db.transaction(tx => {
        tx.executeSql(
          'SELECT * FROM passports WHERE id = ?',
          [id],
          async (_, { rows }) => {
            if (rows.length === 0) {
              resolve(null);
              return;
            }

            const encrypted = rows._array[0];
            
            // 解密
            const decrypted = {
              id: encrypted.id,
              passport_no: await this.encryption.decrypt(encrypted.encrypted_passport_no),
              name: await this.encryption.decrypt(encrypted.encrypted_name),
              date_of_birth: await this.encryption.decrypt(encrypted.encrypted_dob),
              expiry: encrypted.expiry,
              created_at: encrypted.created_at
            };
            
            resolve(decrypted);
          },
          (_, error) => reject(error)
        );
      });
    });
  }

  // 删除所有数据（GDPR被遗忘权）
  async deleteAllData(userId) {
    return new Promise((resolve, reject) => {
      this.db.transaction(tx => {
        // 删除所有表
        tx.executeSql('DELETE FROM passports');
        tx.executeSql('DELETE FROM generation_history');
        tx.executeSql('DELETE FROM settings');
      }, reject, resolve);
    });

    // 删除加密密钥
    await SecureStore.deleteItemAsync(`key_${userId}`);
  }
}

export default new SecureStorage();
```

### 6.2 隐私政策模板

```javascript
// /screens/PrivacyPolicyScreen.jsx
export default function PrivacyPolicyScreen() {
  return (
    <ScrollView style={styles.container}>
      <Text style={styles.title}>隐私政策</Text>
      
      <Text style={styles.section}>1. 我们收集的信息</Text>
      <Text style={styles.content}>
        • 微信账号信息：昵称、头像（用于登录）{'\n'}
        • 证件信息：护照号、姓名、有效期（用于生成入境表格）{'\n'}
        • 使用记录：生成历史、目的地（用于改进服务）
      </Text>

      <Text style={styles.section}>2. 信息的使用</Text>
      <Text style={styles.content}>
        我们使用收集的信息：{'\n'}
        • 生成入境表格{'\n'}
        • 提供个性化服务{'\n'}
        • 改进产品功能
      </Text>

      <Text style={styles.section}>3. 信息的存储</Text>
      <Text style={styles.content}>
        • 本地存储：加密存储在您的手机中{'\n'}
        • 云端备份：加密存储在Cloudflare服务器（欧盟/美国）{'\n'}
        • 加密方式：AES-256加密
      </Text>

      <Text style={styles.section}>4. 信息的分享</Text>
      <Text style={styles.content}>
        我们不会向第三方出售或出租您的个人信息。{'\n'}
        仅在以下情况下处理您的数据：{'\n'}
        • AI服务：阿里云通义千问（仅处理不存储）{'\n'}
        • 法律要求：遵守法律法规
      </Text>

      <Text style={styles.section}>5. 您的权利（GDPR/PIPL）</Text>
      <Text style={styles.content}>
        • 访问权：查看我们存储的您的数据{'\n'}
        • 更正权：修改不准确的数据{'\n'}
        • 删除权：要求删除您的数据{'\n'}
        • 可携权：导出您的数据
      </Text>

      <Text style={styles.section}>6. 数据保留</Text>
      <Text style={styles.content}>
        • 账号存续期间：持续保留{'\n'}
        • 删除账号后：30天内完全删除
      </Text>

      <Text style={styles.section}>7. 联系我们</Text>
      <Text style={styles.content}>
        如有隐私问题，请联系：{'\n'}
        邮箱：privacy@borderbuddy.com
      </Text>

      <Button
        title="我已阅读并同意"
        onPress={handleAccept}
      />
    </ScrollView>
  );
}
```

---

## 七、总结

### ✅ 加密存储

**Cloudflare自动提供：**
1. ✅ TLS 1.3传输加密
2. ✅ AES-256静态数据加密
3. ✅ 密钥自动管理

**我们额外实现：**
4. ✅ 应用层加密（敏感字段）
5. ✅ 用户专属密钥
6. ✅ 本地SQLite加密（可选）

### ✅ GDPR合规

**Cloudflare提供：**
1. ✅ 完全GDPR合规
2. ✅ 数据处理协议（DPA）
3. ✅ 欧盟数据中心选项
4. ✅ ISO/SOC认证

**我们需要实现：**
5. ✅ 用户知情同意
6. ✅ 隐私政策
7. ✅ 数据访问/删除API
8. ✅ 数据导出功能
9. ✅ 处理活动记录

### 🎯 最佳实践

```
分层安全:
├── 传输层: TLS 1.3 ✅
├── 存储层: D1自动加密 ✅
├── 应用层: AES-256字段加密 ✅
└── 设备层: 本地加密存储 ✅

合规:
├── GDPR: 欧盟用户 ✅
├── PIPL: 中国用户 ✅
├── 数据最小化 ✅
├── 用户权利 ✅
└── 透明公开 ✅
```

**总结：完全可以满足加密和合规要求！** ✅

---

**文档版本：** v1.0  
**最后更新：** 2025-06-01  
**结论：安全合规，可以放心使用**

---

END OF DOCUMENT
