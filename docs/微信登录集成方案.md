# 微信登录集成方案

> **核心目标**: 使用微信 OAuth 作为主要登录方式，适配大陆用户习惯

---

## 一、为什么选择微信登录？

### 1.1 用户覆盖

- **13亿+** 中国用户
- **几乎100%** 智能手机用户都有微信
- **中老年友好** - 他们都会用微信，不用教
- **即时验证** - 一键授权，无需记密码

### 1.2 vs. 其他登录方式

| 方式 | 覆盖率 | 易用性 | 成本 | 适合人群 |
|------|--------|--------|------|---------|
| 💬 **微信登录** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 免费 | 大陆用户 |
| 📱 手机号+SMS | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ¥0.05/次 | 所有用户 |
| 💰 支付宝 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 免费 | 支付场景 |
| 🍎 Apple ID | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 免费 | iOS用户 |
| 📧 邮箱 | ⭐⭐ | ⭐⭐ | 免费 | 技术用户 |

**结论**: 微信登录最适合中国大陆用户，特别是中老年群体

---

## 二、微信登录类型

### 2.1 移动应用登录（我们用这个）⭐

```
┌─────────────────────────────────┐
│        您的APP                  │
│                                 │
│   [点击微信登录按钮]            │
│          ↓                      │
│   [跳转到微信APP]               │
│          ↓                      │
│   微信内授权确认                │
│   "通关助手想获取你的头像、昵称" │
│   [允许] [拒绝]                 │
│          ↓                      │
│   [返回您的APP]                 │
│          ↓                      │
│   登录成功！                    │
└─────────────────────────────────┘
```

**特点：**
- ✅ 体验最好
- ✅ 用户熟悉
- ✅ 安全性高
- ⚠️ 需要在微信开放平台申请

### 2.2 网页授权（备用）

适用于 H5 页面或 WebView

**我们的策略：**
- 主要用 2.1 移动应用登录
- 如果没安装微信，降级到手机号登录

---

## 三、申请微信开放平台账号

### 3.1 准备材料

**开发者账号需要：**
- ✅ 企业营业执照（或个体工商户）
- ✅ 对公银行账户
- ✅ 企业邮箱
- ✅ 法人身份证

**认证费用：**
- ¥300/年 企业认证费

**审核时间：**
- 1-3个工作日

### 3.2 申请步骤

```
1. 注册微信开放平台账号
   https://open.weixin.qq.com
   
2. 完成开发者资质认证
   上传营业执照、填写企业信息
   
3. 创建移动应用
   填写APP信息、图标、介绍
   
4. 填写Android/iOS应用包名和签名
   Android: com.yourcompany.borderbuddy
   iOS: Bundle Identifier
   
5. 提交审核
   等待1-3天
   
6. 获取AppID和AppSecret
   审核通过后可在后台获取
```

### 3.3 必备信息

**APP信息：**
```
应用名称: 通关助手
应用简介: 智能出入境助手，AI帮你过海关
应用官网: https://yourapp.com
应用图标: 1024x1024 PNG

应用分类: 旅游出行
```

**Android信息：**
```
应用包名: com.borderbuddy.app
应用签名: (用keytool生成)

# 生成签名命令
keytool -list -v -keystore your.keystore
```

**iOS信息：**
```
Bundle ID: com.borderbuddy.app
Universal Links: https://yourapp.com/apple-app-site-association
```

---

## 四、技术实现方案

### 4.1 技术架构

```
React Native APP
      ↓
react-native-wechat-lib (SDK)
      ↓
微信APP (用户授权)
      ↓
获取 code
      ↓
发送到后端 Cloudflare Worker
      ↓
用 code 换取 access_token + openid
      ↓
获取用户信息 (昵称、头像)
      ↓
创建/更新用户记录
      ↓
返回 JWT token
      ↓
APP 保存 token，登录完成
```

### 4.2 前端实现（React Native）

**安装依赖：**
```bash
npm install react-native-wechat-lib
```

**配置微信SDK：**
```javascript
// /src/services/wechat.js
import * as WeChat from 'react-native-wechat-lib';

// 初始化微信SDK
export async function initWechat() {
  try {
    await WeChat.registerApp(
      'wx1234567890abcdef', // 你的微信AppID
      'https://yourapp.com/' // Universal Link (iOS)
    );
    console.log('✅ 微信SDK初始化成功');
  } catch (error) {
    console.error('❌ 微信SDK初始化失败', error);
  }
}

// 检查微信是否安装
export async function isWechatInstalled() {
  return await WeChat.isWXAppInstalled();
}

// 微信登录
export async function loginWithWechat() {
  try {
    // 1. 检查是否安装微信
    const installed = await isWechatInstalled();
    if (!installed) {
      throw new Error('未安装微信，请使用手机号登录');
    }

    // 2. 发起微信授权
    const result = await WeChat.sendAuthRequest(
      'snsapi_userinfo', // 获取用户信息权限
      'wechat_login' // state参数，用于防CSRF
    );

    // 3. 用户授权成功，获得code
    const { code } = result;
    console.log('✅ 获取到微信授权code:', code);

    // 4. 发送code到后端，换取用户信息
    const response = await fetch('https://your-worker.workers.dev/api/wechat-login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ code })
    });

    const data = await response.json();

    // 5. 保存token和用户信息
    return {
      success: true,
      user: data.user,
      token: data.token
    };

  } catch (error) {
    console.error('❌ 微信登录失败', error);
    return {
      success: false,
      error: error.message
    };
  }
}
```

**登录界面：**
```javascript
// /screens/LoginScreen.jsx
import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, Image, StyleSheet } from 'react-native';
import { initWechat, loginWithWechat, isWechatInstalled } from '@/services/wechat';
import { useNavigation } from '@react-navigation/native';

export default function LoginScreen() {
  const [hasWechat, setHasWechat] = useState(false);
  const [loading, setLoading] = useState(false);
  const navigation = useNavigation();

  useEffect(() => {
    // 初始化微信SDK
    initWechat();
    
    // 检查是否安装微信
    isWechatInstalled().then(setHasWechat);
  }, []);

  const handleWechatLogin = async () => {
    setLoading(true);
    
    const result = await loginWithWechat();
    
    if (result.success) {
      // 保存用户信息到全局状态
      // 跳转到主页
      navigation.replace('Home');
    } else {
      alert(result.error);
    }
    
    setLoading(false);
  };

  const handlePhoneLogin = () => {
    // 跳转到手机号登录页面
    navigation.navigate('PhoneLogin');
  };

  return (
    <View style={styles.container}>
      {/* Logo */}
      <Image 
        source={require('@/assets/logo.png')} 
        style={styles.logo}
      />
      
      <Text style={styles.title}>欢迎使用通关助手</Text>
      <Text style={styles.subtitle}>扫一扫证件，AI帮你过海关</Text>

      {/* 微信登录按钮 */}
      {hasWechat && (
        <TouchableOpacity 
          style={styles.wechatButton}
          onPress={handleWechatLogin}
          disabled={loading}
        >
          <Image 
            source={require('@/assets/wechat-icon.png')} 
            style={styles.wechatIcon}
          />
          <Text style={styles.wechatButtonText}>
            {loading ? '登录中...' : '微信登录'}
          </Text>
        </TouchableOpacity>
      )}

      {/* 分割线 */}
      <View style={styles.divider}>
        <View style={styles.dividerLine} />
        <Text style={styles.dividerText}>或</Text>
        <View style={styles.dividerLine} />
      </View>

      {/* 手机号登录按钮 */}
      <TouchableOpacity 
        style={styles.phoneButton}
        onPress={handlePhoneLogin}
      >
        <Text style={styles.phoneButtonText}>手机号登录</Text>
      </TouchableOpacity>

      {/* 提示文字 */}
      <Text style={styles.hint}>
        登录即表示同意 
        <Text style={styles.link}>《用户协议》</Text>
        和
        <Text style={styles.link}>《隐私政策》</Text>
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#fff',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  logo: {
    width: 120,
    height: 120,
    marginBottom: 30,
  },
  title: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#000',
    marginBottom: 10,
  },
  subtitle: {
    fontSize: 16,
    color: '#666',
    marginBottom: 50,
  },
  wechatButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#07C160', // 微信绿
    paddingVertical: 15,
    paddingHorizontal: 60,
    borderRadius: 50,
    marginBottom: 20,
  },
  wechatIcon: {
    width: 24,
    height: 24,
    marginRight: 10,
  },
  wechatButtonText: {
    color: '#fff',
    fontSize: 18,
    fontWeight: '600',
  },
  divider: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 30,
    width: '80%',
  },
  dividerLine: {
    flex: 1,
    height: 1,
    backgroundColor: '#ddd',
  },
  dividerText: {
    marginHorizontal: 15,
    color: '#999',
    fontSize: 14,
  },
  phoneButton: {
    borderWidth: 1,
    borderColor: '#ddd',
    paddingVertical: 15,
    paddingHorizontal: 60,
    borderRadius: 50,
  },
  phoneButtonText: {
    color: '#333',
    fontSize: 16,
  },
  hint: {
    marginTop: 40,
    fontSize: 12,
    color: '#999',
    textAlign: 'center',
  },
  link: {
    color: '#0066CC',
  },
});
```

### 4.3 后端实现（Cloudflare Worker）

**创建 Worker：**
```bash
wrangler init wechat-worker
```

**实现代码：**
```javascript
// workers/wechat-login/index.js
// Cloudflare Worker for WeChat Login

export default {
  async fetch(request, env) {
    try {
      // 1. 获取前端传来的code
      const { code } = await request.json();

      if (!code) {
        return new Response(
          JSON.stringify({ error: '缺少code参数' }),
          { status: 400, headers: { 'Content-Type': 'application/json' } }
        );
      }

      // 2. 用code换取access_token和openid
      const tokenUrl = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${env.WECHAT_APP_ID}&secret=${env.WECHAT_APP_SECRET}&code=${code}&grant_type=authorization_code`;
      
      const tokenResponse = await fetch(tokenUrl);
      const tokenData = await tokenResponse.json();

      if (tokenData.errcode) {
        throw new Error(`微信API错误: ${tokenData.errmsg}`);
      }

      const { access_token, openid } = tokenData;

      // 3. 用access_token获取用户信息
      const userInfoUrl = `https://api.weixin.qq.com/sns/userinfo?access_token=${access_token}&openid=${openid}&lang=zh_CN`;
      
      const userInfoResponse = await fetch(userInfoUrl);
      const userInfo = await userInfoResponse.json();

      if (userInfo.errcode) {
        throw new Error(`获取用户信息失败: ${userInfo.errmsg}`);
      }

      // 4. 在Cloudflare D1数据库中创建或更新用户
      // 查找是否已存在该微信用户
      const existingUser = await env.DB.prepare(
        'SELECT * FROM users WHERE wechat_openid = ?'
      ).bind(openid).first();

      let user;

      if (existingUser) {
        // 更新用户信息
        await env.DB.prepare(`
          UPDATE users 
          SET nickname = ?, avatar = ?, updated_at = ?
          WHERE wechat_openid = ?
        `).bind(
          userInfo.nickname,
          userInfo.headimgurl,
          new Date().toISOString(),
          openid
        ).run();
        
        user = await env.DB.prepare(
          'SELECT * FROM users WHERE wechat_openid = ?'
        ).bind(openid).first();
      } else {
        // 创建新用户
        await env.DB.prepare(`
          INSERT INTO users (
            wechat_openid, wechat_unionid, nickname, avatar,
            gender, country, province, city, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          openid,
          userInfo.unionid || null,
          userInfo.nickname,
          userInfo.headimgurl,
          userInfo.sex, // 1=男, 2=女, 0=未知
          userInfo.country,
          userInfo.province,
          userInfo.city,
          new Date().toISOString()
        ).run();
        
        user = await env.DB.prepare(
          'SELECT * FROM users WHERE wechat_openid = ?'
        ).bind(openid).first();
      }

      // 5. 生成JWT token (使用自定义JWT或第三方库)
      const token = await generateJWT(user, env.JWT_SECRET);

      // 6. 返回用户信息和token
      return new Response(
        JSON.stringify({
          success: true,
          user: {
            id: user.id,
            nickname: user.nickname,
            avatar: user.avatar,
            openid: openid
          },
          token: token
        }),
        { 
          status: 200, 
          headers: { 'Content-Type': 'application/json' } 
        }
      );

    } catch (error) {
      console.error('微信登录错误:', error);
      
      return new Response(
        JSON.stringify({ 
          success: false,
          error: error.message 
        }),
        { 
          status: 500, 
          headers: { 'Content-Type': 'application/json' } 
        }
      );
    }
  }
};

// JWT生成函数(简化版,实际使用请用jose库)
async function generateJWT(user, secret) {
  // 实际项目中使用 jose 或其他JWT库
  // npm install jose
  const jose = await import('jose');
  const jwt = await new jose.SignJWT({
    userId: user.id,
    openid: user.wechat_openid
  })
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(new TextEncoder().encode(secret));
  
  return jwt;
}
```

**配置 wrangler.toml：**
```toml
name = "wechat-worker"
main = "src/index.js"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "trip-secretary"
database_id = "your-database-id"

[vars]
# 这些不是secret,可以公开
# WECHAT_APP_ID = "wx..." # 通过 wrangler secret put 设置

# Secret 通过命令行设置
# wrangler secret put WECHAT_APP_ID
# wrangler secret put WECHAT_APP_SECRET
# wrangler secret put JWT_SECRET
```

**设置环境变量：**
```bash
wrangler secret put WECHAT_APP_ID
# 输入: wx1234567890abcdef

wrangler secret put WECHAT_APP_SECRET
# 输入: your_app_secret_here

wrangler secret put JWT_SECRET
# 输入: your_jwt_secret_here
```

### 4.4 数据库Schema更新

```sql
-- Cloudflare D1 表结构 (SQLite语法)
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  wechat_openid TEXT UNIQUE NOT NULL,
  wechat_unionid TEXT,
  nickname TEXT,
  avatar TEXT,
  gender INTEGER DEFAULT 0, -- 0=未知, 1=男, 2=女
  country TEXT,
  province TEXT,
  city TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_users_wechat_openid ON users(wechat_openid);
CREATE INDEX IF NOT EXISTS idx_users_wechat_unionid ON users(wechat_unionid);

-- 部署到D1
-- wrangler d1 execute trip-secretary --file=./migrations/001_users.sql
```

---

## 五、iOS配置（重要）

### 5.1 配置Universal Links

**为什么需要：**
- iOS 9+ 要求使用Universal Links
- 微信登录后需要跳回你的APP

**步骤：**

1. **在你的域名根目录放置文件：**
   ```
   https://yourapp.com/.well-known/apple-app-site-association
   ```

2. **文件内容：**
   ```json
   {
     "applinks": {
       "apps": [],
       "details": [
         {
           "appID": "TEAM_ID.com.borderbuddy.app",
           "paths": [
             "/wechat/*"
           ]
         }
       ]
     }
   }
   ```

3. **在Xcode中配置：**
   - Signing & Capabilities
   - 添加 Associated Domains
   - 添加：`applinks:yourapp.com`

4. **在Info.plist中添加：**
   ```xml
   <key>LSApplicationQueriesSchemes</key>
   <array>
     <string>wechat</string>
     <string>weixin</string>
     <string>weixinULAPI</string>
   </array>
   ```

5. **在AppDelegate中处理Universal Links：**
   ```swift
   func application(_ application: UIApplication, 
                    continue userActivity: NSUserActivity,
                    restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
     return WXApi.handleOpenUniversalLink(userActivity, delegate: self)
   }
   ```

---

## 六、Android配置

### 6.1 AndroidManifest.xml

```xml
<manifest>
  <application>
    <!-- 微信登录回调 -->
    <activity
      android:name=".wxapi.WXEntryActivity"
      android:label="@string/app_name"
      android:exported="true"
      android:taskAffinity="com.borderbuddy.app"
      android:launchMode="singleTask">
    </activity>
  </application>
  
  <!-- 微信权限 -->
  <queries>
    <package android:name="com.tencent.mm" />
  </queries>
</manifest>
```

### 6.2 创建WXEntryActivity

```kotlin
// android/app/src/main/java/com/borderbuddy/app/wxapi/WXEntryActivity.kt
package com.borderbuddy.app.wxapi

import android.app.Activity
import android.os.Bundle
import com.theweflex.react.WeChatModule

class WXEntryActivity : Activity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    WeChatModule.handleIntent(intent)
    finish()
  }
}
```

---

## 七、测试流程

### 7.1 开发环境测试

```bash
# 1. 启动本地开发服务器
npm start

# 2. 在真机上测试（不能用模拟器）
# 微信登录必须在真机上测试

# 3. 点击微信登录按钮
# 观察console日志

# 4. 授权后应该能看到：
# ✅ 获取到code
# ✅ 后端返回用户信息
# ✅ 跳转到首页
```

### 7.2 常见问题排查

**问题1: 提示"未安装微信"**
- 检查：真的安装了微信吗？
- 检查：AndroidManifest.xml 中的 queries 配置

**问题2: 点击微信登录无反应**
- 检查：AppID是否正确
- 检查：应用是否已通过微信审核
- 检查：应用签名是否匹配

**问题3: 授权后无法返回APP**
- iOS: 检查Universal Links配置
- Android: 检查WXEntryActivity配置

**问题4: 后端报错"invalid code"**
- code只能使用一次
- code有效期5分钟
- 检查系统时间是否正确

---

## 八、用户隐私和合规

### 8.1 必须告知用户

```
登录即表示同意：

1. 我们将获取您的微信昵称和头像
2. 我们不会获取您的微信好友列表
3. 我们不会向您的微信好友发送消息
4. 您的证件信息仅用于生成入境材料
5. 所有数据加密存储
```

### 8.2 隐私政策必须包含

- 收集哪些微信信息
- 信息用于什么目的
- 是否分享给第三方
- 用户如何删除数据
- 联系方式

---

## 九、成本分析

### 9.1 微信登录成本

**开发成本：**
- 微信开放平台认证: ¥300/年
- 开发时间: 2-3天

**运营成本：**
- API调用: 免费
- 服务器: Supabase免费额度内

**总结：非常便宜！** ✅

---

## 十、降级方案

### 10.1 如果用户没有微信

```javascript
// 检测微信并提供降级选项
const handleLogin = async () => {
  const hasWechat = await isWechatInstalled();
  
  if (!hasWechat) {
    // 提示用户使用手机号登录
    Alert.alert(
      '未安装微信',
      '您可以使用手机号登录',
      [
        { text: '使用手机号', onPress: () => navigation.navigate('PhoneLogin') },
        { text: '取消', style: 'cancel' }
      ]
    );
    return;
  }
  
  // 继续微信登录流程
  await loginWithWechat();
};
```

### 10.2 国产手机用户（重要）⭐

**现实情况：**
- 华为、小米、OPPO、vivo等国产手机
- 可能没有预装Google Play Services
- 但100%都有微信

**这就是为什么微信登录最适合：**
- ✅ 不依赖Google服务
- ✅ 纯国产技术栈
- ✅ 华为鸿蒙系统也支持
- ✅ 所有Android手机都能用

### 10.3 香港用户考虑

**问题：香港用户可能不常用微信**

**解决方案：**
```
┌─────────────────────────────┐
│   选择登录方式              │
│                             │
│  [💬 微信登录]  (大陆用户推荐)│
│                             │
│  [📱 手机号登录] (香港用户推荐)│
│                             │
│  [🍎 Apple ID登录] (iOS)   │
└─────────────────────────────┘
```

**智能推荐：**
```javascript
// 根据手机系统语言自动推荐
const recommendLoginMethod = () => {
  const locale = NativeModules.I18nManager.localeIdentifier;
  
  if (locale.includes('zh_CN')) {
    // 大陆用户 - 推荐微信
    return 'wechat';
  } else if (locale.includes('zh_HK') || locale.includes('zh_TW')) {
    // 港台用户 - 推荐手机号
    return 'phone';
  }
  
  return 'phone'; // 默认
};
```

---

## 十一、开发时间表

### Week 1: 准备工作
- Day 1-2: 申请微信开放平台账号
- Day 3-4: 等待审核
- Day 5: 获取AppID和Secret

### Week 2: 开发集成
- Day 1-2: 前端集成react-native-wechat-lib
- Day 3-4: 后端实现Supabase Edge Function
- Day 5: iOS/Android配置

### Week 3: 测试上线
- Day 1-3: 真机测试
- Day 4-5: 修复bug，准备上线

---

## 十二、后续优化

### V1.0（MVP）
- ✅ 微信登录
- ✅ 手机号登录（备选）

### V2.0（未来）
- 支付宝登录（支付场景）
- QQ登录（可选）
- 微信小程序版本
- UnionID支持（多应用账号互通）

---

## 总结

✅ **微信登录是最佳选择**
- 覆盖13亿用户
- 中老年友好
- 免费使用
- 安全可靠

✅ **特别适合国产手机**
- 华为、小米、OPPO、vivo 100%支持
- 不依赖Google服务
- 华为鸿蒙系统也能用
- 比Apple ID覆盖面更广

✅ **配合手机号登录**
- 香港用户备选
- 没安装微信的用户（极少）

✅ **开发成本低**
- 认证费 ¥300/年
- 开发时间 2-3天
- 运营成本几乎为0

🚀 **可以开始开发了！**

---

## 附录：国产手机市场份额（2025）

| 品牌 | 市场份额 | 微信支持 | Google服务 |
|------|---------|---------|-----------|
| 华为 | 23% | ✅ | ❌ (HMS) |
| 小米 | 18% | ✅ | ✅ |
| OPPO | 16% | ✅ | ✅ |
| vivo | 15% | ✅ | ✅ |
| 荣耀 | 12% | ✅ | ✅ |
| Apple | 16% | ✅ | ✅ |

**关键发现：**
- 84%的手机是国产品牌
- 100%的手机支持微信
- 只有23%的手机（华为）没有Google服务
- **结论：微信登录是唯一能覆盖所有用户的方案**

---

**文档版本：** v1.0  
**最后更新：** 2025-06-01  

---

END OF DOCUMENT
