# Schema v2.0 Migration: SecureStorageService Updates\n\n**Date**: 2025-10-22\n**Status**: ✅ Complete\n**Impact**: HIGH - Critical database service updates for v2.0 schema compatibility\n\n---\n\n## Overview\n\nUpdated `SecureStorageService.js` to support the new schema v2.0, which fundamentally changes how entry packs and TDAC submissions are managed. The key change is moving from `entry_packs` table (which is removed) to directly linking Digital Arrival Cards to `entry_info`.\n\n---\n\n## Key Changes\n\n### 1. Digital Arrival Cards Methods (NEW)\n\nCreated new v2.0-compliant methods:\n\n#### `saveDigitalArrivalCard(cardData)`\n- **Schema**: Uses `digital_arrival_cards` table\n- **Key fields**: `entry_info_id`, `card_type`, `destination_id`, `pdf_url`\n- **Replaces**: `saveTDACSubmissionMetadata()` (now backward compatible alias)\n\n```javascript\nawait storageService.saveDigitalArrivalCard({\n  id: 'dac-123',\n  entryInfoId: 'entry-456',  // Links directly to entry_info\n  userId: 1,\n  cardType: 'TDAC',           // Can be TDAC, MDAC, SDAC, HKDAC\n  destinationId: 'THA',\n  arrCardNo: '1234567',\n  qrUri: 'https://...',\n  pdfUrl: 'https://...',      // Changed from pdfPath\n  submittedAt: '2025-10-22T...',\n  status: 'success',\n  // ... other fields\n});\n```\n\n#### `getDigitalArrivalCard(cardId)`\n- Retrieves single DAC by ID\n- Replaces: `getTDACSubmission()` alias\n\n#### `getDigitalArrivalCardsByUserId(userId, filters)`\n- Retrieves DACs for a user with filtering\n- Supports filters: `status`, `destinationId`, `entryInfoId`, `cardType`, `isSuperseded`\n- Replaces: `getTDACSubmissionsByUserId()` alias\n\n#### `getDigitalArrivalCardsByEntryInfoId(entryInfoId)`\n- Retrieves all DACs for an entry info (v2.0 replacement for entry pack)\n- Replaces: `getTDACSubmissionsByEntryPackId()` alias\n\n#### `updateDigitalArrivalCard(cardData)` & `deleteDigitalArrivalCard(cardId)`\n- Standard CRUD operations for DACs\n- Replaces: `updateTDACSubmission()`, `deleteTDACSubmission()` aliases\n\n#### `deserializeDigitalArrivalCard(row)`\n- Converts database row to JavaScript object\n- Includes new fields: `cardType`, `version`\n- Replaces: `deserializeTDACSubmission()` alias\n\n### 2. Entry Info Methods (UPDATED)\n\n#### `serializeEntryInfo(entryInfo)`\n**Before (v1.0)**:\n- Fields: `id`, `user_id`, `passport_id`, `personal_info_id`, `destination_id`, `trip_id`, `status`, `completion_metrics`, etc.\n- Had: `arrival_date`, `departure_date`, `travel_purpose`, `flight_number`, `accommodation`\n\n**After (v2.0)**:\n- Fields: `id`, `user_id`, `passport_id`, `personal_info_id`, `travel_info_id` (NEW), `destination_id`, `status`, `completion_metrics`\n- Added: `documents` (JSON), `display_status` (JSON)\n- Removed: `trip_id`, travel-related fields (now in separate `travel_info` table)\n- Renamed: `last_updated_at` (was spread across multiple fields)\n\n#### `deserializeEntryInfo(row)`\n- Updated to map v2.0 schema fields\n- Now extracts `travelInfoId` instead of individual travel fields\n- Extracts JSON objects for `documents` and `displayStatus`\n\n### 3. Backward Compatibility Aliases\n\nAll old TDAC methods now delegate to new DAC methods with automatic field mapping:\n\n```javascript\n// Old method - still works\nawait service.saveTDACSubmissionMetadata({\n  entryPackId: 'pack-123',  // Automatically mapped to entryInfoId\n  pdfPath: 'path/to/file',  // Automatically mapped to pdfUrl\n  cardType: 'TDAC'\n});\n\n// Internally calls:\nawait service.saveDigitalArrivalCard({\n  entryInfoId: 'pack-123',   // Mapped from entryPackId\n  pdfUrl: 'path/to/file',    // Mapped from pdfPath\n  cardType: 'TDAC'           // Passed through\n});\n```\n\n**Compatibility Aliases**:\n- `saveTDACSubmissionMetadata()` → `saveDigitalArrivalCard()`\n- `getTDACSubmission()` → `getDigitalArrivalCard()`\n- `getTDACSubmissionsByUserId()` → `getDigitalArrivalCardsByUserId()` (adds `cardType: 'TDAC'` filter)\n- `getTDACSubmissionsByEntryPackId()` → `getDigitalArrivalCardsByEntryInfoId()`\n- `updateTDACSubmission()` → `updateDigitalArrivalCard()`\n- `deleteTDACSubmission()` → `deleteDigitalArrivalCard()`\n- `deserializeTDACSubmission()` → `deserializeDigitalArrivalCard()`\n\n### 4. Deprecated Methods\n\nAudit event methods deprecated (table removed in v2.0):\n\n```javascript\n// These now return empty/no-op results with deprecation warnings\nawait service.getAuditEventsBySnapshotId() → returns []\nawait service.getAuditEventsByUserId() → returns []\nawait service.deleteAuditEvents() → returns { success: true, rowsAffected: 0, deprecated: true }\nservice.deserializeAuditEvent() → returns { deprecated: true }\n```\n\n---\n\n## Database Schema Changes\n\n### Removed Tables\n- `entry_packs` - Functionality merged into `entry_info`\n- `entry_pack_snapshots` - Snapshots feature removed\n- `tdac_submissions` - Replaced by `digital_arrival_cards`\n- `audit_events` - Audit logging removed (can be re-added separately if needed)\n\n### New/Modified Tables\n\n#### `digital_arrival_cards` (NEW)\n```sql\nCREATE TABLE digital_arrival_cards (\n  id TEXT PRIMARY KEY,\n  entry_info_id TEXT NOT NULL,      -- Links directly to entry_info (no entry_packs)\n  user_id INTEGER NOT NULL,\n  card_type TEXT NOT NULL,           -- TDAC, MDAC, SDAC, HKDAC\n  destination_id TEXT,\n  arr_card_no TEXT,\n  qr_uri TEXT,\n  pdf_url TEXT,                      -- Changed from pdf_path\n  submitted_at DATETIME NOT NULL,\n  submission_method TEXT DEFAULT 'api',\n  status TEXT DEFAULT 'success',\n  api_response TEXT,\n  processing_time INTEGER,\n  retry_count INTEGER DEFAULT 0,\n  error_details TEXT,\n  is_superseded INTEGER DEFAULT 0,\n  superseded_at DATETIME,\n  superseded_by TEXT,\n  superseded_reason TEXT,\n  version INTEGER DEFAULT 1,         -- NEW: tracks card version\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (entry_info_id) REFERENCES entry_info(id) ON DELETE CASCADE,\n  FOREIGN KEY (user_id) REFERENCES users(id)\n);\n```\n\n#### `entry_info` (MODIFIED)\n```sql\nCREATE TABLE entry_info (\n  id TEXT PRIMARY KEY,\n  user_id INTEGER NOT NULL,\n  passport_id TEXT NOT NULL,\n  personal_info_id TEXT,\n  travel_info_id TEXT,               -- NEW: links to travel_info table\n  destination_id TEXT,\n  status TEXT DEFAULT 'incomplete',\n  completion_metrics TEXT,\n  documents TEXT,                    -- NEW: JSON {qrCodeImage, pdfDocument, etc}\n  display_status TEXT,               -- NEW: JSON {completionPercent, categoryStates, etc}\n  last_updated_at DATETIME,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (passport_id) REFERENCES passports(id),\n  FOREIGN KEY (personal_info_id) REFERENCES personal_info(id),\n  FOREIGN KEY (travel_info_id) REFERENCES travel_info(id)\n);\n```\n\n---\n\n## Migration Path for Existing Code\n\n### For Code Using Old Methods\n\n**No immediate changes required** - backward compatibility aliases provide automatic translation:\n\n```javascript\n// Old code still works (v1.0 style)\nconst submission = await service.getTDACSubmission(id);\nawait service.updateTDACSubmission(submission);\n\n// Internally uses new v2.0 methods - automatic field mapping\n```\n\n### For New Code\n\nUse the new v2.0 methods directly:\n\n```javascript\n// New v2.0 style - preferred\nconst card = await service.getDigitalArrivalCard(id);\nawait service.updateDigitalArrivalCard(card);\n```\n\n### Migration Strategy\n\n1. **Phase 1**: Update SecureStorageService ✅ (DONE)\n2. **Phase 2**: Update high-level services (PassportDataService, EntryDataService)\n3. **Phase 3**: Update screens and components\n4. **Phase 4**: Data migration for existing users (optional)\n5. **Phase 5**: Remove v1.0 compatibility code (after all code updated)\n\n---\n\n## Testing Checklist\n\n- [ ] New v2.0 methods store data correctly in `digital_arrival_cards`\n- [ ] Backward compatibility aliases work with old method calls\n- [ ] Field mapping works correctly (entryPackId → entryInfoId, pdfPath → pdfUrl)\n- [ ] Entry info serialization/deserialization includes new fields\n- [ ] Query filters work correctly (cardType, isSuperseded, etc.)\n- [ ] Triggers work (auto-superseding of previous DACs)\n- [ ] Deprecated methods return appropriate warnings/empty results\n\n---\n\n## Files Modified\n\n- `app/services/security/SecureStorageService.js` - Main changes\n- `docs/SCHEMA_V2_IMPLEMENTATION_PROGRESS.md` - Progress tracking\n\n---\n\n## Next Steps\n\n1. Update `PassportDataService.js` to use new DAC methods\n2. Update `EntryDataService.js` for entry_info changes\n3. Update screens to use new methods\n4. Run full test suite\n5. Test in development app\n"}