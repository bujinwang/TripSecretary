┌──────────────────────────────────────────────────────────────────────────┐
│                    Flash API Submission Flow Diagram                      │
│                        "闪电提交" (TDACAPIScreen)                        │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│    USER     │ Fills form and clicks "提交"
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  TDACAPIScreen.js:169                                           │
│  ────────────────────────                                       │
│  const result = await TDACAPIService.submitArrivalCard()        │
│                                                                 │
│  Returns:                                                       │
│    { success: true,                                            │
│      arrCardNo: 'TH12345',                                     │
│      pdfBlob: Blob,           ← PDF FROM TDAC API              │
│      duration: '2.34s' }                                       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  TDACAPIScreen.js:174 - saveQRCode()                            │
│  ────────────────────────────────────                           │
│  Step 1: Save PDF to Documents Folder                          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  PDFManagementService.savePDF():86-131                          │
│  ───────────────────────────────────────                        │
│                                                                 │
│  1. Create directory: Documents/tdac/                           │
│  2. Generate filename: TDAC_{cardNo}_{timestamp}.pdf           │
│  3. Convert blob → base64 → Uint8Array                         │
│  4. Write to file                                              │
│                                                                 │
│  ✅ SAVED: Documents/tdac/TDAC_TH12345_1730000000.pdf          │
│                                                                 │
│  Returns:                                                       │
│    { filepath: 'file:///.../TDAC_TH12345_1730000000.pdf',     │
│      filename: 'TDAC_TH12345_1730000000.pdf',                 │
│      size: 214567 }                                            │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ├──────────────────────┐
                      │                      │
                      ▼                      ▼
┌─────────────────────────────┐   ┌──────────────────────────────┐
│  Step 2a: AsyncStorage      │   │  Step 2b: Photo Album        │
│  ────────────────────────   │   │  ─────────────────────────   │
│                             │   │                              │
│  Save to AsyncStorage:      │   │  MediaLibrary.createAsset()  │
│    • tdac_{cardNo}          │   │                              │
│    • recent_tdac_submission │   │  ⚠️  SAVES FULL PDF!        │
│                             │   │  (Not just QR code)          │
│  Purpose: Legacy storage,   │   │                              │
│  quick access               │   │  Security Risk:              │
│                             │   │  Sensitive data in photos    │
└─────────────────────────────┘   └──────────────────────────────┘
                      │
                      │ Both complete
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  TDACAPIScreen.js:191 - TDACSubmissionService                   │
│  ─────────────────────────────────────────────────────          │
│  Step 3: Create Digital Arrival Card Record                    │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  TDACSubmissionService.handleTDACSubmissionSuccess():33         │
│  ────────────────────────────────────────────────────           │
│                                                                 │
│  3a. Extract & Validate Metadata                               │
│      → extractTDACSubmissionMetadata()                         │
│      → validateTDACSubmissionMetadata()                        │
│                                                                 │
│  3b. Find or Create Entry Info ID                              │
│      → findOrCreateEntryInfoId()                               │
│      Returns: 'entry_info_456'                                 │
│                                                                 │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  TDACSubmissionService.js:77                                    │
│  ─────────────────────────────                                  │
│  3c. Save to digital_arrival_cards table                       │
│                                                                 │
│  UserDataService.saveDigitalArrivalCard({                      │
│    entryInfoId: 'entry_info_456',                             │
│    cardType: 'TDAC',                                           │
│    arrCardNo: 'TH12345',                                       │
│    qrUri: 'file:///.../TDAC_TH12345_1730000000.pdf',         │
│    pdfUrl: 'file:///.../TDAC_TH12345_1730000000.pdf', ← PDF! │
│    submittedAt: '2025-10-28T...',                             │
│    submissionMethod: 'api',                                    │
│    status: 'success'                                           │
│  })                                                            │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  UserDataService.js:842                                         │
│  ───────────────────────                                        │
│  → SecureStorageService.saveDigitalArrivalCard():494          │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  DigitalArrivalCardRepository.save():23                         │
│  ────────────────────────────────────────                       │
│                                                                 │
│  INSERT INTO digital_arrival_cards (                           │
│    id,                     'dac_abc123'                        │
│    entry_info_id,          'entry_info_456'                    │
│    user_id,                'user_001'                          │
│    card_type,              'TDAC'                              │
│    destination_id,         'THA'                               │
│    arr_card_no,            'TH12345'         ← CARD NUMBER    │
│    qr_uri,                 'file:///.../pdf'                   │
│    pdf_url,                'file:///.../pdf' ← PDF PATH       │
│    submitted_at,           '2025-10-28T...'                    │
│    submission_method,      'api'                               │
│    status,                 'success'                           │
│    version,                1                                   │
│    ...                                                         │
│  ) VALUES (...)                                                │
│                                                                 │
│  ✅ DATABASE RECORD CREATED                                    │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ├─────────────────────┬─────────────────────┐
                      │                     │                     │
                      ▼                     ▼                     ▼
┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────┐
│  3d. Create Snapshot │  │ 3e. Update Entry Info│  │  COMPLETE!       │
│  ──────────────────  │  │ ───────────────────  │  │  ────────────    │
│                      │  │                      │  │                  │
│  SnapshotService     │  │  Status:             │  │  Show success    │
│  .createSnapshot()   │  │  'incomplete'        │  │  message to user │
│                      │  │       ↓              │  │                  │
│  Immutable data      │  │  'submitted'         │  │  arrCardNo shown │
│  snapshot at time    │  │                      │  │                  │
│  of submission       │  │                      │  │                  │
└──────────────────────┘  └──────────────────────┘  └──────────────────┘


═══════════════════════════════════════════════════════════════════
                        DATA STORAGE LOCATIONS
═══════════════════════════════════════════════════════════════════

1. FILESYSTEM (Documents)
   ─────────────────────────
   📁 Documents/tdac/TDAC_TH12345_1730000000.pdf
   Size: ~200-500 KB
   Content: Full TDAC PDF with QR code and all personal data
   Security: ✅ Private to app

2. PHOTO ALBUM
   ─────────────
   📷 iOS Photos / Android Gallery
   Content: ⚠️ FULL PDF (not just QR!)
   Security: ⚠️ Sensitive data accessible in photo album
   Issue: Passport number, name, DOB, etc. visible

3. ASYNCSTORAGE
   ─────────────
   Keys:
     • tdac_{arrCardNo}
     • recent_tdac_submission
   Purpose: Legacy storage, quick access
   Security: ✅ Private to app

4. DATABASE (SQLite)
   ──────────────────
   Table: digital_arrival_cards
   Record ID: dac_abc123
   Key Fields:
     • arr_card_no: 'TH12345'           ← Display to user
     • pdf_url: 'file:///.../pdf'       ← Path to PDF file
     • qr_uri: 'file:///.../pdf'        ← Same as pdf_url
     • entry_info_id: 'entry_info_456'  ← Links to entry
     • status: 'success'                ← Submission status
   Security: ✅ Private to app


═══════════════════════════════════════════════════════════════════
                        KEY OBSERVATIONS
═══════════════════════════════════════════════════════════════════

✅ WORKS WELL:
   • PDF properly saved to Documents folder
   • Database record correctly created with all metadata
   • PDF path stored in digital_arrival_cards.pdf_url
   • Graceful error handling throughout
   • Multiple storage layers for redundancy

⚠️  ISSUES:
   • Full PDF saved to photo album (security risk)
   • Misleading comment: "QR code saved" but saves full PDF
   • qrUri and pdfUrl point to same path (confusing naming)
   • AsyncStorage duplicates database data

🔧 RECOMMENDATIONS:
   1. Extract QR code from PDF, save only QR image to photos
   2. Fix misleading comment on line 312
   3. Consider deprecating AsyncStorage in favor of database
   4. Separate qrUri from pdfUrl (different file paths)

