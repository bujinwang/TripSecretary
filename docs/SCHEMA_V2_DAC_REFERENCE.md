# Schema v2.0: Digital Arrival Cards (DAC) Quick Reference\n\n## Quick Summary\n\nDigital Arrival Cards replace TDAC Submissions. They now link directly to `entry_info` instead of `entry_packs`.\n\n**Key Change**: `entry_pack_id` → `entry_info_id`\n\n---\n\n## Method Reference\n\n### Create/Save\n\n```javascript\n// V2.0 (NEW)\nawait service.saveDigitalArrivalCard({\n  id: string,\n  entryInfoId: string,           // Was: entryPackId\n  userId: number,\n  cardType: 'TDAC' | 'MDAC' | 'SDAC' | 'HKDAC',\n  destinationId: string,\n  arrCardNo: string,\n  qrUri: string,\n  pdfUrl: string,                // Was: pdfPath\n  submittedAt: string,           // ISO datetime\n  submissionMethod: string,      // 'api' | 'manual'\n  status: string,                // 'success', 'pending', 'failed'\n  apiResponse: object,           // Optional\n  processingTime: number,        // Optional\n  retryCount: number,            // Optional, default 0\n  errorDetails: object,          // Optional\n  isSuperseded: boolean,         // Optional, default false\n  supersededAt: string,          // Optional\n  supersededReason: string,      // Optional\n  supersededBy: string,          // Optional, ID of newer card\n  version: number,               // Optional, default 1\n  createdAt: string,             // ISO datetime, auto-set if not provided\n  updatedAt: string              // ISO datetime, auto-set if not provided\n});\n\n// V1.0 (DEPRECATED but still works via alias)\nawait service.saveTDACSubmissionMetadata({\n  entryPackId: string,           // Auto-mapped to entryInfoId\n  pdfPath: string,               // Auto-mapped to pdfUrl\n  // ... other fields\n});\n```\n\n### Read\n\n```javascript\n// Get single DAC by ID\nconst card = await service.getDigitalArrivalCard(cardId);\n\n// Get all DACs for a user\nconst cards = await service.getDigitalArrivalCardsByUserId(userId, {\n  status: 'success',             // Optional filter\n  destinationId: 'THA',          // Optional filter\n  cardType: 'TDAC',              // Optional filter\n  entryInfoId: 'entry-123',      // Optional filter (entry_info_id)\n  isSuperseded: false,           // Optional filter\n  limit: 10,                     // Optional\n  offset: 0                      // Optional\n});\n\n// Get all DACs for an entry_info (replaces entry_pack queries)\nconst cardsForEntry = await service.getDigitalArrivalCardsByEntryInfoId(entryInfoId);\n\n// V1.0 deprecated methods (still work via aliases)\nawait service.getTDACSubmission(submissionId);\nawait service.getTDACSubmissionsByUserId(userId, filters);\nawait service.getTDACSubmissionsByEntryPackId(entryPackId);\n```\n\n### Update\n\n```javascript\n// V2.0 (NEW)\nawait service.updateDigitalArrivalCard({\n  id: cardId,\n  status: 'success',\n  apiResponse: { /* ... */ },\n  isSuperseded: true,\n  supersededReason: 'Replaced by newer submission',\n  supersededBy: 'newer-card-id',\n  version: 2,\n  updatedAt: new Date().toISOString()\n});\n\n// V1.0 deprecated\nawait service.updateTDACSubmission(submissionData);\n```\n\n### Delete\n\n```javascript\n// V2.0 (NEW)\nawait service.deleteDigitalArrivalCard(cardId);\n\n// V1.0 deprecated\nawait service.deleteTDACSubmission(submissionId);\n```\n\n### Deserialize (DB Row → Object)\n\n```javascript\n// V2.0 (NEW)\nconst card = service.deserializeDigitalArrivalCard(databaseRow);\n\n// V1.0 deprecated\nconst submission = service.deserializeTDACSubmission(databaseRow);\n```\n\n---\n\n## Field Mapping (v1.0 → v2.0)\n\n| v1.0 Field | v2.0 Field | Type | Notes |\n|---|---|---|---|\n| `entry_pack_id` | `entry_info_id` | TEXT | Now links to entry_info directly |\n| `pdf_path` | `pdf_url` | TEXT | Changed to URL |\n| (new) | `card_type` | TEXT | TDAC, MDAC, SDAC, HKDAC |\n| (new) | `version` | INTEGER | Tracks card version, default 1 |\n| (old) | `trip_id` | REMOVED | No longer needed |\n| `submission_method` | `submission_method` | TEXT | 'api', 'manual' |\n| `arr_card_no` | `arr_card_no` | TEXT | |\n| `qr_uri` | `qr_uri` | TEXT | |\n| `status` | `status` | TEXT | 'success', 'pending', 'failed' |\n| `is_superseded` | `is_superseded` | INTEGER | 0 or 1 |\n| `retry_count` | `retry_count` | INTEGER | |\n| `api_response` | `api_response` | TEXT (JSON) | |\n| `error_details` | `error_details` | TEXT (JSON) | |\n\n---\n\n## Returned Object Structure\n\n```javascript\n{\n  id: string,\n  entryInfoId: string,\n  userId: number,\n  cardType: string,              // 'TDAC', 'MDAC', 'SDAC', 'HKDAC'\n  destinationId: string,\n  arrCardNo: string | null,\n  qrUri: string | null,\n  pdfUrl: string | null,\n  submittedAt: string,\n  submissionMethod: string,\n  status: string,\n  apiResponse: object | null,    // Parsed from JSON\n  processingTime: number | null,\n  retryCount: number,\n  errorDetails: object | null,   // Parsed from JSON\n  isSuperseded: boolean,\n  supersededAt: string | null,\n  supersededReason: string | null,\n  supersededBy: string | null,\n  version: number,\n  createdAt: string,\n  updatedAt: string\n}\n```\n\n---\n\n## Automatic Superseding (Trigger)\n\nWhen a new DAC is inserted with `status='success'` and `is_superseded=0`:\n\n```sql\nUPDATE digital_arrival_cards\nSET is_superseded = 1,\n    superseded_at = CURRENT_TIMESTAMP,\n    superseded_by = NEW.id,\n    superseded_reason = 'Replaced by newer successful submission'\nWHERE entry_info_id = NEW.entry_info_id\n  AND card_type = NEW.card_type\n  AND id != NEW.id\n  AND is_superseded = 0;\n```\n\n**Effect**: Automatically marks previous DACs of the same type for the same entry as superseded.\n\n---\n\n## Common Queries\n\n### Get Latest Successful TDAC for Entry\n\n```javascript\nconst cards = await service.getDigitalArrivalCardsByEntryInfoId(entryInfoId);\nconst latest = cards\n  .filter(c => c.cardType === 'TDAC' && c.status === 'success' && !c.isSuperseded)\n  .sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))[0];\n```\n\n### Get All Pending DACs for User\n\n```javascript\nconst pending = await service.getDigitalArrivalCardsByUserId(userId, {\n  status: 'pending'\n});\n```\n\n### Get All Superseded DACs\n\n```javascript\nconst superseded = await service.getDigitalArrivalCardsByUserId(userId, {\n  isSuperseded: true,\n  limit: 100\n});\n```\n\n### Get DACs by Destination\n\n```javascript\nconst thaiDACs = await service.getDigitalArrivalCardsByUserId(userId, {\n  destinationId: 'THA'\n});\n```\n\n---\n\n## Deprecation Status\n\n### Fully Migrated ✅\n- TDAC Submission methods → DAC methods\n- Entry Pack references → Entry Info references\n\n### Deprecated (Still Work) ⚠️\n- All `getTDACSubmissionBy*` methods (use `getDigitalArrivalCardBy*` instead)\n- All `*TDACSubmission()` methods (use `*DigitalArrivalCard()` instead)\n- Audit event methods (table removed, use DAC status instead)\n\n### Removed 🔴\n- `entry_packs` table (merged into `entry_info`)\n- `entry_pack_snapshots` table (snapshots feature removed)\n- `tdac_submissions` table (replaced by `digital_arrival_cards`)\n- `audit_events` table (audit logging removed)\n\n---\n\n## Testing\n\n```javascript\n// Example test\ntest('saveDigitalArrivalCard creates new DAC', async () => {\n  const card = await service.saveDigitalArrivalCard({\n    id: 'test-card-1',\n    entryInfoId: 'test-entry-1',\n    userId: 1,\n    cardType: 'TDAC',\n    destinationId: 'THA',\n    arrCardNo: '1234567',\n    qrUri: 'https://example.com/qr',\n    pdfUrl: 'https://example.com/pdf',\n    submittedAt: new Date().toISOString(),\n    status: 'success'\n  });\n  \n  expect(card).toHaveProperty('success', true);\n  expect(card).toHaveProperty('id', 'test-card-1');\n});\n\ntest('getDigitalArrivalCardsByEntryInfoId returns entry DACs', async () => {\n  const cards = await service.getDigitalArrivalCardsByEntryInfoId('test-entry-1');\n  \n  expect(Array.isArray(cards)).toBe(true);\n  expect(cards[0]).toHaveProperty('entryInfoId', 'test-entry-1');\n});\n```\n"}