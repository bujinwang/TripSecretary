/**
  * TDAC Selection Screen - Redesigned for User Experience
  * ËÆ©Áî®Êà∑ÈÄâÊã©ÊúÄÈÄÇÂêàÁöÑÂÖ•Â¢ÉÂç°Êèê‰∫§ÊñπÂºèÔºåËÅöÁÑ¶‰∫éÁî®Êà∑‰ΩìÈ™åËÄåÈùûÊäÄÊúØÁªÜËäÇ
  */

import React from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  Alert,
} from 'react-native';
import { colors } from '../../theme';
// Removed mockTDACData dependency - using pure user data
import EntryInfoService from '../../services/EntryInfoService';
import SnapshotService from '../../services/snapshot/SnapshotService';
import PassportDataService from '../../services/data/PassportDataService';
import TDACValidationService from '../../services/validation/TDACValidationService';
import TDACErrorHandler from '../../services/error/TDACErrorHandler';

const TDACSelectionScreen = ({ navigation, route }) => {
  const incomingTravelerInfo = (route.params && route.params.travelerInfo) || {};
  
  // Log incoming data for debugging
  console.log('üîç TDACSelectionScreen received travelerInfo:', {
    hasData: Object.keys(incomingTravelerInfo).length > 0,
    keys: Object.keys(incomingTravelerInfo),
    passportNo: incomingTravelerInfo.passportNo,
    familyName: incomingTravelerInfo.familyName,
    firstName: incomingTravelerInfo.firstName,
    arrivalDate: incomingTravelerInfo.arrivalDate,
    email: incomingTravelerInfo.email
  });
  
  // Use pure user data directly - no mock data fallbacks
  const travelerInfo = incomingTravelerInfo;
  
  // Log user data for debugging
  console.log('üîç Using pure user data:', {
    passportNo: travelerInfo.passportNo,
    familyName: travelerInfo.familyName,
    firstName: travelerInfo.firstName,
    arrivalDate: travelerInfo.arrivalDate,
    email: travelerInfo.email,
    flightNo: travelerInfo.flightNo
  });

  /**
   * Handle successful TDAC submission by creating/updating entry pack
   * This is called when user returns from successful TDAC submission
   */
  const handleTDACSubmissionSuccess = async (submissionData) => {
    try {
      console.log('üéâ Handling TDAC submission success:', submissionData);

      // Task 4.2: Extract and validate all necessary fields from TDAC submission
      const tdacSubmission = extractTDACSubmissionMetadata(submissionData);

      // Validate metadata completeness (must have arrCardNo and qrUri)
      if (!validateTDACSubmissionMetadata(tdacSubmission)) {
        console.warn('‚ö†Ô∏è Invalid TDAC submission metadata:', tdacSubmission);
        return;
      }

      // Record submission history
      const submissionHistoryEntry = {
        timestamp: tdacSubmission.submittedAt,
        status: 'success',
        method: tdacSubmission.submissionMethod,
        arrCardNo: tdacSubmission.arrCardNo,
        duration: submissionData.duration || null,
        metadata: {
          qrUri: tdacSubmission.qrUri,
          pdfPath: tdacSubmission.pdfPath,
          travelerName: submissionData.travelerName,
          passportNo: submissionData.passportNo,
          arrivalDate: submissionData.arrivalDate
        }
      };

      console.log('üìã Submission history entry:', submissionHistoryEntry);

      // Find or create entry info ID (placeholder - would need actual implementation)
      const entryInfoId = await findOrCreateEntryInfoId(travelerInfo);

      if (entryInfoId) {
        // Create or update digital arrival card
        const digitalArrivalCard = await PassportDataService.saveDigitalArrivalCard({
          entryInfoId: entryInfoId,
          cardType: 'TDAC', // Default to TDAC, can be extended for other types
          arrCardNo: tdacSubmission.arrCardNo,
          qrUri: tdacSubmission.qrUri,
          pdfUrl: tdacSubmission.pdfPath,
          submittedAt: tdacSubmission.submittedAt,
          submissionMethod: tdacSubmission.submissionMethod,
          status: 'success'
        });

        console.log('‚úÖ Digital arrival card created/updated:', {
          cardId: digitalArrivalCard.id,
          arrCardNo: tdacSubmission.arrCardNo,
          status: digitalArrivalCard.status
        });

        // Task 4.2: Record submission history
        await recordSubmissionHistory(digitalArrivalCard.id, submissionHistoryEntry);

        // Task 4.3: Create entry info snapshot immediately after creating digital arrival card
        await createEntryInfoSnapshot(entryInfoId, 'submission', {
          appVersion: '1.0.0', // Would get from app config
          deviceInfo: 'mobile', // Would get from device info
          creationMethod: 'auto',
          submissionMethod: tdacSubmission.submissionMethod
        });

        // Task 4.4: Update EntryInfo status from 'ready' to 'submitted'
        await updateEntryInfoStatus(entryInfoId, tdacSubmission);
        
      } else {
        console.warn('‚ö†Ô∏è Could not find or create entry info ID');
      }

    } catch (error) {
      console.error('‚ùå Failed to handle TDAC submission success:', error);
      
      // Enhanced error handling with retry mechanisms and user-friendly reporting
      const errorResult = await TDACErrorHandler.handleSubmissionError(error, {
        operation: 'digital_arrival_card_creation',
        submissionMethod: tdacSubmission.submissionMethod,
        arrCardNo: tdacSubmission.arrCardNo,
        userAgent: 'TDACSelectionScreen'
      }, 0);

      console.log('üìã Error handling result:', errorResult);

      // Show user-friendly error dialog
      const errorDialog = TDACErrorHandler.createErrorDialog(errorResult);
      
      Alert.alert(
        errorDialog.title,
        `${errorDialog.message}\n\nError ID: ${errorResult.errorId}`,
        [
          {
            text: 'Retry Later',
            onPress: () => {
              // Schedule retry or show instructions
              console.log('User chose to retry later');
            }
          },
          {
            text: 'Continue Anyway',
            onPress: () => {
              console.log('User chose to continue despite error');
            }
          },
          {
            text: 'Contact Support',
            onPress: async () => {
              // Export error log for support
              const errorLog = await TDACErrorHandler.exportErrorLog();
              console.log('Error log exported for support:', errorResult.errorId);
            }
          }
        ]
      );
      
      // Record the failure with enhanced logging
      try {
        const AsyncStorage = require('@react-native-async-storage/async-storage').default;
        const failureLog = {
          timestamp: new Date().toISOString(),
          errorId: errorResult.errorId,
          category: errorResult.category,
          userMessage: errorResult.userMessage,
          technicalMessage: errorResult.technicalMessage,
          recoverable: errorResult.recoverable,
          error: error.message,
          stack: error.stack,
          submissionData: JSON.stringify(arguments[0]),
          suggestions: errorResult.suggestions
        };
        
        await AsyncStorage.setItem('digital_arrival_card_creation_failures', JSON.stringify(failureLog));
        console.log('üìù Enhanced digital arrival card creation failure logged:', errorResult.errorId);
      } catch (logError) {
        console.error('‚ùå Failed to log entry pack creation failure:', logError);
      }
    }
  };

  /**
   * Task 4.2: Extract all necessary fields from TDAC API response
   * Standardizes metadata from different submission methods (API/WebView/Hybrid)
   */
  const extractTDACSubmissionMetadata = (submissionData) => {
    return {
      arrCardNo: submissionData.arrCardNo || submissionData.cardNo,
      qrUri: submissionData.qrUri || submissionData.fileUri || submissionData.src,
      pdfPath: submissionData.pdfPath || submissionData.fileUri,
      submittedAt: submissionData.submittedAt || submissionData.timestamp 
        ? new Date(submissionData.submittedAt || submissionData.timestamp).toISOString()
        : new Date().toISOString(),
      submissionMethod: submissionData.submissionMethod || 'unknown'
    };
  };

  /**
   * Task 4.2: Enhanced TDAC submission metadata validation with comprehensive error handling
   */
  const validateTDACSubmissionMetadata = (tdacSubmission) => {
    try {
      console.log('üîç Starting comprehensive TDAC validation...');
      
      // Use comprehensive validation service
      const validationResult = TDACValidationService.validateTDACSubmission(tdacSubmission, {
        strict: true,
        checkFiles: false // Skip file checks for performance
      });

      if (!validationResult.isValid) {
        console.error('‚ùå TDAC validation failed:', {
          errors: validationResult.errors,
          fieldErrors: validationResult.fieldErrors
        });

        // Show user-friendly error messages
        const summary = TDACValidationService.getValidationSummary(validationResult);
        
        // Display validation errors to user
        if (summary.criticalErrors.length > 0) {
          console.error('üö® Critical validation errors:', summary.criticalErrors);
          
          // Show alert with specific field errors
          const fieldErrorMessages = Object.entries(validationResult.fieldErrors)
            .map(([field, errors]) => {
              const message = TDACValidationService.getFieldErrorMessage(field, errors);
              return `‚Ä¢ ${field}: ${message}`;
            })
            .join('\n');

          if (fieldErrorMessages) {
            Alert.alert(
              '‚ùå Validation Failed',
              `Please correct the following issues:\n\n${fieldErrorMessages}`,
              [{ text: 'OK' }]
            );
          }
        }

        return false;
      }

      // Log warnings if any
      if (validationResult.warnings.length > 0) {
        console.warn('‚ö†Ô∏è TDAC validation warnings:', validationResult.warnings);
      }

      console.log('‚úÖ TDAC validation passed');
      return true;

    } catch (error) {
      console.error('‚ùå TDAC validation error:', error);
      
      // Fallback to basic validation
      const required = ['arrCardNo', 'qrUri'];
      const missing = required.filter(field => !tdacSubmission[field] || !tdacSubmission[field].trim());
      
      if (missing.length > 0) {
        console.error('‚ùå Missing required TDAC submission fields:', missing);
        Alert.alert(
          '‚ùå Missing Information',
          `Required fields missing: ${missing.join(', ')}`,
          [{ text: 'OK' }]
        );
        return false;
      }

      return true;
    }
  };

  /**
    * Task 4.2: Record submission history to submissionHistory array
    */
   const recordSubmissionHistory = async (digitalArrivalCardId, submissionHistoryEntry) => {
     try {
       // This would integrate with DigitalArrivalCard model to append to submissionHistory array
       console.log('üìù Recording submission history:', {
         digitalArrivalCardId,
         entry: submissionHistoryEntry
       });

       // For now, just log - actual implementation would update DigitalArrivalCard.submissionHistory
       return true;
     } catch (error) {
       console.error('‚ùå Failed to record submission history:', error);
       return false;
     }
   };

  /**
    * Task 4.3: Create entry info snapshot
    * Creates immutable snapshot of entry info data after successful TDAC submission
    */
   const createEntryInfoSnapshot = async (entryInfoId, reason = 'submission', metadata = {}) => {
     try {
       console.log('üì∏ Creating entry info snapshot:', {
         entryInfoId,
         reason,
         metadata
       });

       // Optional: Display snapshot creation progress
       // This could be a toast or loading indicator
       // For now, we'll just log the progress

       console.log('üì∏ Starting snapshot creation process...');

       // Call SnapshotService to create snapshot
       const snapshot = await SnapshotService.createSnapshot(entryInfoId, reason, metadata);

       if (snapshot) {
         console.log('‚úÖ Entry info snapshot created successfully:', {
           snapshotId: snapshot.snapshotId,
           entryInfoId: entryInfoId,
           reason: reason,
           photoCount: snapshot.getPhotoCount(),
           createdAt: snapshot.createdAt
         });

         // Optional: Display success notification
         // Toast.show({
         //   type: 'success',
         //   text1: 'Entry Info Saved',
         //   text2: 'Your travel documents have been securely archived.',
         //   position: 'bottom',
         //   visibilityTime: 3000,
         // });

         return snapshot;
       } else {
         throw new Error('Snapshot creation returned null');
       }

     } catch (error) {
       console.error('‚ùå Failed to create entry info snapshot:', error);

       // Task 4.3: Handle snapshot creation failure gracefully
       // Don't block the user flow, but log the error for debugging

       try {
         const AsyncStorage = require('@react-native-async-storage/async-storage').default;
         const failureLog = {
           timestamp: new Date().toISOString(),
           entryInfoId,
           reason,
           error: error.message,
           stack: error.stack,
           metadata
         };

         await AsyncStorage.setItem('snapshot_creation_failures', JSON.stringify(failureLog));
         console.log('üìù Snapshot creation failure logged');
       } catch (logError) {
         console.error('‚ùå Failed to log snapshot creation failure:', logError);
       }

       // Optional: Display non-blocking warning
       // Toast.show({
       //   type: 'info',
       //   text1: 'Archive Warning',
       //   text2: 'Documents saved but archival incomplete. Your TDAC is still valid.',
       //   position: 'bottom',
       //   visibilityTime: 4000,
       // });

       return null;
     }
   };

  /**
   * Find or create entry info ID for the traveler
   * This implementation looks for existing EntryInfo or creates a new one
   */
  const findOrCreateEntryInfoId = async (travelerInfo) => {
    try {
      const userId = 'current_user'; // Would get from auth context
      const destinationId = 'thailand';
      
      console.log('üîç Looking for existing entry info...');
      
      // Try to find existing entry info for this user and destination
      const PassportDataService = require('../../services/data/PassportDataService').default;
      let entryInfo = await PassportDataService.getEntryInfo(userId, destinationId);
      
      if (entryInfo) {
        console.log('‚úÖ Found existing entry info:', entryInfo.id);
        return entryInfo.id;
      }
      
      console.log('üìù Creating new entry info...');
      
      // Create new entry info if none exists
      const entryInfoData = {
        destinationId,
        status: 'incomplete',
        completionMetrics: {
          passport: { complete: 0, total: 5, state: 'missing' },
          personalInfo: { complete: 0, total: 6, state: 'missing' },
          funds: { complete: 0, total: 1, state: 'missing' },
          travel: { complete: 0, total: 6, state: 'missing' }
        },
        lastUpdatedAt: new Date().toISOString()
      };
      
      entryInfo = await PassportDataService.saveEntryInfo(entryInfoData, userId);
      console.log('‚úÖ Created new entry info:', entryInfo.id);
      
      return entryInfo.id;
    } catch (error) {
      console.error('‚ùå Failed to find/create entry info ID:', error);
      return null;
    }
  };

  /**
   * Task 4.4: Update EntryInfo status from 'ready' to 'submitted'
   * Ensures proper state transitions and triggers notification system
   */
  const updateEntryInfoStatus = async (entryInfoId, tdacSubmission) => {
    try {
      console.log('üìã Updating EntryInfo status to submitted...');
      
      const PassportDataService = require('../../services/data/PassportDataService').default;
      
      // Update EntryInfo status from 'ready' to 'submitted'
      const updatedEntryInfo = await PassportDataService.updateEntryInfoStatus(
        entryInfoId,
        'submitted',
        {
          reason: 'TDAC submission successful',
          tdacSubmission: {
            arrCardNo: tdacSubmission.arrCardNo,
            qrUri: tdacSubmission.qrUri,
            pdfPath: tdacSubmission.pdfPath,
            submittedAt: tdacSubmission.submittedAt,
            submissionMethod: tdacSubmission.submissionMethod
          }
        }
      );
      
      console.log('‚úÖ EntryInfo status updated successfully:', {
        entryInfoId: updatedEntryInfo.id,
        oldStatus: 'ready',
        newStatus: updatedEntryInfo.status,
        submissionDate: updatedEntryInfo.submissionDate,
        lastUpdatedAt: updatedEntryInfo.lastUpdatedAt
      });
      
      // Trigger state change event for notification system
      console.log('üì¢ State change event triggered for notification system');
      
      return updatedEntryInfo;
    } catch (error) {
      console.error('‚ùå Failed to update EntryInfo status:', error);
      
      // Log the failure but don't throw - this is a secondary operation
      // The TDAC submission was successful, so we don't want to break the user flow
      try {
        const AsyncStorage = require('@react-native-async-storage/async-storage').default;
        const failureLog = {
          timestamp: new Date().toISOString(),
          entryInfoId,
          error: error.message,
          stack: error.stack,
          tdacSubmission: JSON.stringify(tdacSubmission)
        };
        
        await AsyncStorage.setItem('entry_info_status_update_failures', JSON.stringify(failureLog));
        console.log('üìù EntryInfo status update failure logged');
      } catch (logError) {
        console.error('‚ùå Failed to log EntryInfo status update failure:', logError);
      }
      
      return null;
    }
  };

  // Listen for navigation focus to check for successful submissions
  React.useEffect(() => {
    const unsubscribe = navigation.addListener('focus', async () => {
      try {
        // Check AsyncStorage for recent TDAC submissions
        const AsyncStorage = require('@react-native-async-storage/async-storage').default;
        
        // Check for recent submissions in the last 5 minutes
        const recentSubmissionKey = 'recent_tdac_submission';
        const recentSubmissionData = await AsyncStorage.getItem(recentSubmissionKey);
        
        if (recentSubmissionData) {
          const submissionData = JSON.parse(recentSubmissionData);
          const submissionTime = new Date(submissionData.timestamp || submissionData.submittedAt);
          const now = new Date();
          const timeDiff = now.getTime() - submissionTime.getTime();
          
          // If submission was within last 5 minutes, process it
          if (timeDiff < 5 * 60 * 1000) {
            console.log('üîç Found recent TDAC submission:', submissionData);
            await handleTDACSubmissionSuccess(submissionData);
            
            // Clear the recent submission flag
            await AsyncStorage.removeItem(recentSubmissionKey);
          }
        }
      } catch (error) {
        console.error('‚ùå Error checking for recent submissions:', error);
      }
    });

    return unsubscribe;
  }, [navigation]);

  return (
    <ScrollView style={styles.container}>
      {/* ÊÉÖÊÑüÂåñÂ§¥ÈÉ® */}
      <View style={styles.heroSection}>
        <Text style={styles.heroEmoji}>üåü</Text>
        <Text style={styles.heroTitle}>Âø´ÈÄüÂÖ•Â¢ÉÔºåÊó†ÂøßÈÄöÂÖ≥</Text>
        <Text style={styles.heroSubtitle}>
          ÈÄâÊã©ÊúÄÈÄÇÂêàÊÇ®ÁöÑÊ≥∞ÂõΩÂÖ•Â¢ÉÂç°Êèê‰∫§ÊñπÂºèÔºå{'\n'}ËÆ©ÈÄöÂÖ≥Êõ¥ÁÆÄÂçï„ÄÅÊõ¥ÂÆâÂøÉ
        </Text>
      </View>

      {/* Âø´ÈÄüÈÄöÈÅìÈÄâÈ°π */}
      <View style={styles.optionSection}>
        <TouchableOpacity
          style={[styles.optionCard, styles.recommendedCard]}
          onPress={() => navigation.navigate('TDACHybrid', { travelerInfo })}
          activeOpacity={0.8}
        >
          {/* Êé®ËçêÂæΩÁ´† */}
          <View style={styles.recommendationBadge}>
            <Text style={styles.recommendationIcon}>üì±</Text>
            <Text style={styles.recommendationText}>Êé®ËçêÈÄâÊã©</Text>
          </View>

          {/* Ê†áÈ¢òÂå∫Âüü */}
          <View style={styles.cardHeader}>
            <Text style={styles.optionIcon}>‚ö°</Text>
            <View style={styles.titleSection}>
              <Text style={styles.optionTitle}>Èó™ÁîµÊèê‰∫§</Text>
              <Text style={styles.optionSubtitle}>Âø´ÈÄüÈÄöÈÅì ¬∑ Êô∫ËÉΩÈ™åËØÅ</Text>
            </View>
          </View>

          {/* Ê†∏ÂøÉ‰ºòÂäø */}
          <View style={styles.benefitsSection}>
            <View style={styles.benefitItem}>
              <Text style={styles.benefitIcon}>‚è±Ô∏è</Text>
              <View>
                <Text style={styles.benefitValue}>5-8Áßí</Text>
                <Text style={styles.benefitLabel}>Èó™ÁîµÂÆåÊàê</Text>
              </View>
            </View>

            <View style={styles.benefitItem}>
              <Text style={styles.benefitIcon}>üéØ</Text>
              <View>
                <Text style={styles.benefitValue}>95%+</Text>
                <Text style={styles.benefitLabel}>Ë∂ÖÈ´òÊàêÂäüÁéá</Text>
              </View>
            </View>

            <View style={styles.benefitItem}>
              <Text style={styles.benefitIcon}>üöÄ</Text>
              <View>
                <Text style={styles.benefitValue}>Âø´3ÂÄç</Text>
                <Text style={styles.benefitLabel}>ÊØî‰º†ÁªüÊñπÂºè</Text>
              </View>
            </View>
          </View>

          {/* Áî®Êà∑Âà©Áõä */}
          <View style={styles.userBenefits}>
            <Text style={styles.benefitsTitle}>‚ú® ËÆ©ÊÇ®Êõ¥ÁúÅÂøÉ</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ ËäÇÁúÅÂÆùË¥µÊó∂Èó¥ÔºåÈÅøÂÖçÊéíÈòüÁÑ¶Ëôë</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ Âø´ÈÄüËé∑ÂæóÁ°ÆËÆ§ÔºåÂÆâÂøÉÁ≠âÂæÖÁôªÊú∫</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ ‰∏ì‰∏öÂõ¢Èòü‰øùÈöúÔºåÂÖ®Á®ãÊäÄÊúØÊîØÊåÅ</Text>
          </View>

          {/* Ë°åÂä®ÊåâÈíÆ */}
          <TouchableOpacity
            style={styles.actionButton}
            onPress={() => navigation.navigate('TDACHybrid', { travelerInfo })}
          >
            <Text style={styles.actionButtonText}>Á´ãÂç≥‰ΩìÈ™åÈó™ÁîµÊèê‰∫§ ‚Üí</Text>
          </TouchableOpacity>
        </TouchableOpacity>
      </View>

      {/* Á®≥ÂÆöÈÄöÈÅìÈÄâÈ°π */}
      <View style={styles.optionSection}>
        <TouchableOpacity
          style={[styles.optionCard, styles.stableCard]}
          onPress={() => navigation.navigate('TDACWebView', { travelerInfo })}
          activeOpacity={0.8}
        >
          {/* Ê†áÈ¢òÂå∫Âüü */}
          <View style={styles.cardHeader}>
            <Text style={[styles.optionIcon, styles.stableIcon]}>üõ°Ô∏è</Text>
            <View style={styles.titleSection}>
              <Text style={[styles.optionTitle, styles.stableTitle]}>Á®≥Â¶•Êèê‰∫§</Text>
              <Text style={[styles.optionSubtitle, styles.stableSubtitle]}>Á®≥ÂÆöÈÄöÈÅì ¬∑ Ê∏ÖÊô∞ÂèØËßÅ</Text>
            </View>
          </View>

          {/* Ê†∏ÂøÉÊåáÊ†á */}
          <View style={styles.benefitsSection}>
            <View style={styles.benefitItem}>
              <Text style={styles.benefitIcon}>‚è±Ô∏è</Text>
              <View>
                <Text style={[styles.benefitValue, styles.stableValue]}>24Áßí</Text>
                <Text style={styles.benefitLabel}>Á®≥ÂÆöÂÆåÊàê</Text>
              </View>
            </View>

            <View style={styles.benefitItem}>
              <Text style={styles.benefitIcon}>üéØ</Text>
              <View>
                <Text style={[styles.benefitValue, styles.stableValue]}>85%</Text>
                <Text style={styles.benefitLabel}>ÂèØÈù†ÊàêÂäüÁéá</Text>
              </View>
            </View>
          </View>

          {/* Áî®Êà∑Âà©Áõä */}
          <View style={styles.userBenefits}>
            <Text style={styles.benefitsTitle}>‚ú® ÈÄÇÂêàËøô‰∫õÊóÖÂÆ¢</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ ÂñúÊ¨¢ÁúºËßÅ‰∏∫ÂÆûÔºåËøáÁ®ãÊ∏ÖÊô∞ÂèØËßÅ</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ ÂàùÊ¨°‰ΩøÁî®ÔºåÊõ¥ÂñúÊ¨¢Á®≥Â¶•ÁöÑÊñπÂºè</Text>
            <Text style={styles.benefitPoint}>‚Ä¢ ‰∏çËµ∂Êó∂Èó¥ÔºåÂèØ‰ª•ÊÖ¢ÊÖ¢Á°ÆËÆ§</Text>
          </View>

          {/* Ë°åÂä®ÊåâÈíÆ */}
          <TouchableOpacity
            style={[styles.actionButton, styles.stableButton]}
            onPress={() => navigation.navigate('TDACWebView', { travelerInfo })}
          >
            <Text style={[styles.actionButtonText, styles.stableButtonText]}>ÈÄâÊã©Á®≥Â¶•ÊñπÊ°à</Text>
          </TouchableOpacity>
        </TouchableOpacity>
      </View>

      {/* Êô∫ËÉΩÊé®ËçêÊèêÁ§∫ */}
      <View style={styles.smartTipSection}>
        <View style={styles.tipCard}>
          <Text style={styles.tipIcon}>üí°</Text>
          <View style={styles.tipContent}>
            <Text style={styles.tipTitle}>Êô∫ËÉΩÊé®Ëçê</Text>
            <Text style={styles.tipText}>
              Âü∫‰∫éÊÇ®ÁöÑÊóÖË°å‰π†ÊÉØÔºåÊàë‰ª¨Êé®ËçêÈó™ÁîµÊèê‰∫§ÊñπÊ°à„ÄÇ{'\n'}
              Â¶ÇÊûúÊÇ®Êõ¥ÂñúÊ¨¢ÁúºËßÅ‰∏∫ÂÆûÁöÑËøáÁ®ãÔºåÂèØ‰ª•ÈöèÊó∂ÂàáÊç¢Âà∞Á®≥Â¶•ÊñπÊ°à„ÄÇ
            </Text>
          </View>
        </View>
      </View>

      {/* Â∫ïÈÉ®ÈºìÂä±‰ø°ÊÅØ */}
      <View style={styles.footerSection}>
        <Text style={styles.footerEmoji}>üå∫</Text>
        <Text style={styles.footerTitle}>Á•ùÊÇ®Ê≥∞ÂõΩ‰πãÊóÖÊÑâÂø´ÔºÅ</Text>
        <Text style={styles.footerText}>
          Êó†ËÆ∫ÈÄâÊã©Âì™ÁßçÊñπÂºèÔºåÊàë‰ª¨ÈÉΩ‰ºöÂÖ®ÂäõÂçèÂä©ÊÇ®{'\n'}
          È°∫Âà©ÂÆåÊàêÂÖ•Â¢ÉÂç°Êèê‰∫§ÔºåÂÆâÂøÉ‰∫´ÂèóÊ≥∞ÂõΩÂÅáÊúü
        </Text>
      </View>
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },

  // ÊÉÖÊÑüÂåñÂ§¥ÈÉ®Âå∫Âüü
  heroSection: {
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    padding: 24,
    paddingTop: 60,
    alignItems: 'center',
    borderBottomLeftRadius: 24,
    borderBottomRightRadius: 24,
  },
  heroEmoji: {
    fontSize: 48,
    marginBottom: 16,
  },
  heroTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    color: colors.white,
    marginBottom: 12,
    textAlign: 'center',
  },
  heroSubtitle: {
    fontSize: 16,
    color: colors.white,
    opacity: 0.9,
    textAlign: 'center',
    lineHeight: 24,
  },

  // ÈÄâÈ°πÂç°Ê†∑Âºè
  optionSection: {
    margin: 16,
    marginTop: 24,
  },
  optionCard: {
    backgroundColor: colors.white,
    borderRadius: 20,
    padding: 24,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.15,
    shadowRadius: 12,
    elevation: 8,
  },

  // Êé®ËçêÈÄâÈ°πÊ†∑Âºè
  recommendedCard: {
    borderWidth: 3,
    borderColor: '#4CAF50',
    backgroundColor: '#fafcfa',
  },

  // Êé®ËçêÂæΩÁ´†
  recommendationBadge: {
    position: 'absolute',
    top: -12,
    right: 20,
    backgroundColor: '#4CAF50',
    paddingHorizontal: 16,
    paddingVertical: 6,
    borderRadius: 20,
    flexDirection: 'row',
    alignItems: 'center',
  },
  recommendationIcon: {
    color: colors.white,
    fontSize: 14,
    marginRight: 4,
  },
  recommendationText: {
    color: colors.white,
    fontSize: 14,
    fontWeight: 'bold',
  },

  // Âç°ÁâáÂ§¥ÈÉ®
  cardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 20,
  },
  optionIcon: {
    fontSize: 32,
    marginRight: 16,
  },
  stableIcon: {
    opacity: 0.8,
  },
  titleSection: {
    flex: 1,
  },
  optionTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.text,
    marginBottom: 4,
  },
  stableTitle: {
    color: colors.text,
  },
  optionSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  stableSubtitle: {
    opacity: 0.8,
  },

  // ‰ºòÂäøÂ±ïÁ§∫Âå∫Âüü
  benefitsSection: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 24,
    paddingVertical: 20,
    backgroundColor: 'rgba(76, 175, 80, 0.05)',
    borderRadius: 16,
  },
  benefitItem: {
    alignItems: 'center',
    flex: 1,
  },
  benefitIcon: {
    fontSize: 24,
    marginBottom: 8,
  },
  benefitValue: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#4CAF50',
    marginBottom: 2,
  },
  stableValue: {
    color: colors.textSecondary,
  },
  benefitLabel: {
    fontSize: 12,
    color: colors.textSecondary,
    textAlign: 'center',
  },

  // Áî®Êà∑Âà©ÁõäÂå∫Âüü
  userBenefits: {
    marginBottom: 24,
  },
  benefitsTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.text,
    marginBottom: 12,
  },
  benefitPoint: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: 8,
    lineHeight: 20,
  },

  // Ë°åÂä®ÊåâÈíÆ
  actionButton: {
    backgroundColor: '#4CAF50',
    padding: 16,
    borderRadius: 16,
    alignItems: 'center',
  },
  actionButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },

  // Á®≥ÂÆöÈÄâÈ°πÊåâÈíÆÊ†∑Âºè
  stableButton: {
    backgroundColor: colors.white,
    borderWidth: 2,
    borderColor: '#4CAF50',
  },
  stableButtonText: {
    color: '#4CAF50',
  },

  // Êô∫ËÉΩÊé®ËçêÊèêÁ§∫
  smartTipSection: {
    margin: 16,
    marginTop: 8,
  },
  tipCard: {
    backgroundColor: '#E3F2FD',
    borderRadius: 16,
    padding: 20,
    flexDirection: 'row',
    alignItems: 'flex-start',
    borderLeftWidth: 4,
    borderLeftColor: '#2196F3',
  },
  tipIcon: {
    fontSize: 24,
    marginRight: 12,
    marginTop: 2,
  },
  tipContent: {
    flex: 1,
  },
  tipTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1976D2',
    marginBottom: 6,
  },
  tipText: {
    fontSize: 14,
    color: '#424242',
    lineHeight: 20,
  },

  // Â∫ïÈÉ®ÈºìÂä±Âå∫Âüü
  footerSection: {
    margin: 16,
    marginTop: 8,
    alignItems: 'center',
    paddingVertical: 24,
  },
  footerEmoji: {
    fontSize: 36,
    marginBottom: 12,
  },
  footerTitle: {
    fontSize: 20,
    fontWeight: '600',
    color: colors.primary,
    marginBottom: 8,
    textAlign: 'center',
  },
  footerText: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 22,
  },
});

export default TDACSelectionScreen;
