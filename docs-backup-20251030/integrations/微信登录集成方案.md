# å¾®ä¿¡ç™»å½•é›†æˆæ–¹æ¡ˆ

> **æ ¸å¿ƒç›®æ ‡**: ä½¿ç”¨å¾®ä¿¡ OAuth ä½œä¸ºä¸»è¦ç™»å½•æ–¹å¼ï¼Œé€‚é…å¤§é™†ç”¨æˆ·ä¹ æƒ¯

---

## ä¸€ã€ä¸ºä»€ä¹ˆé€‰æ‹©å¾®ä¿¡ç™»å½•ï¼Ÿ

### 1.1 ç”¨æˆ·è¦†ç›–

- **13äº¿+** ä¸­å›½ç”¨æˆ·
- **å‡ ä¹100%** æ™ºèƒ½æ‰‹æœºç”¨æˆ·éƒ½æœ‰å¾®ä¿¡
- **ä¸­è€å¹´å‹å¥½** - ä»–ä»¬éƒ½ä¼šç”¨å¾®ä¿¡ï¼Œä¸ç”¨æ•™
- **å³æ—¶éªŒè¯** - ä¸€é”®æˆæƒï¼Œæ— éœ€è®°å¯†ç 

### 1.2 vs. å…¶ä»–ç™»å½•æ–¹å¼

| æ–¹å¼ | è¦†ç›–ç‡ | æ˜“ç”¨æ€§ | æˆæœ¬ | é€‚åˆäººç¾¤ |
|------|--------|--------|------|---------|
| ğŸ’¬ **å¾®ä¿¡ç™»å½•** | â­â­â­â­â­ | â­â­â­â­â­ | å…è´¹ | å¤§é™†ç”¨æˆ· |
| ğŸ“± æ‰‹æœºå·+SMS | â­â­â­â­â­ | â­â­â­â­ | Â¥0.05/æ¬¡ | æ‰€æœ‰ç”¨æˆ· |
| ğŸ’° æ”¯ä»˜å® | â­â­â­â­ | â­â­â­â­ | å…è´¹ | æ”¯ä»˜åœºæ™¯ |
| ğŸ Apple ID | â­â­â­ | â­â­â­â­â­ | å…è´¹ | iOSç”¨æˆ· |
| ğŸ“§ é‚®ç®± | â­â­ | â­â­ | å…è´¹ | æŠ€æœ¯ç”¨æˆ· |

**ç»“è®º**: å¾®ä¿¡ç™»å½•æœ€é€‚åˆä¸­å›½å¤§é™†ç”¨æˆ·ï¼Œç‰¹åˆ«æ˜¯ä¸­è€å¹´ç¾¤ä½“

---

## äºŒã€å¾®ä¿¡ç™»å½•ç±»å‹

### 2.1 ç§»åŠ¨åº”ç”¨ç™»å½•ï¼ˆæˆ‘ä»¬ç”¨è¿™ä¸ªï¼‰â­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ‚¨çš„APP                  â”‚
â”‚                                 â”‚
â”‚   [ç‚¹å‡»å¾®ä¿¡ç™»å½•æŒ‰é’®]            â”‚
â”‚          â†“                      â”‚
â”‚   [è·³è½¬åˆ°å¾®ä¿¡APP]               â”‚
â”‚          â†“                      â”‚
â”‚   å¾®ä¿¡å†…æˆæƒç¡®è®¤                â”‚
â”‚   "é€šå…³åŠ©æ‰‹æƒ³è·å–ä½ çš„å¤´åƒã€æ˜µç§°" â”‚
â”‚   [å…è®¸] [æ‹’ç»]                 â”‚
â”‚          â†“                      â”‚
â”‚   [è¿”å›æ‚¨çš„APP]                 â”‚
â”‚          â†“                      â”‚
â”‚   ç™»å½•æˆåŠŸï¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä½“éªŒæœ€å¥½
- âœ… ç”¨æˆ·ç†Ÿæ‚‰
- âœ… å®‰å…¨æ€§é«˜
- âš ï¸ éœ€è¦åœ¨å¾®ä¿¡å¼€æ”¾å¹³å°ç”³è¯·

### 2.2 ç½‘é¡µæˆæƒï¼ˆå¤‡ç”¨ï¼‰

é€‚ç”¨äº H5 é¡µé¢æˆ– WebView

**æˆ‘ä»¬çš„ç­–ç•¥ï¼š**
- ä¸»è¦ç”¨ 2.1 ç§»åŠ¨åº”ç”¨ç™»å½•
- å¦‚æœæ²¡å®‰è£…å¾®ä¿¡ï¼Œé™çº§åˆ°æ‰‹æœºå·ç™»å½•

---

## ä¸‰ã€ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·

### 3.1 å‡†å¤‡ææ–™

**å¼€å‘è€…è´¦å·éœ€è¦ï¼š**
- âœ… ä¼ä¸šè¥ä¸šæ‰§ç…§ï¼ˆæˆ–ä¸ªä½“å·¥å•†æˆ·ï¼‰
- âœ… å¯¹å…¬é“¶è¡Œè´¦æˆ·
- âœ… ä¼ä¸šé‚®ç®±
- âœ… æ³•äººèº«ä»½è¯

**è®¤è¯è´¹ç”¨ï¼š**
- Â¥300/å¹´ ä¼ä¸šè®¤è¯è´¹

**å®¡æ ¸æ—¶é—´ï¼š**
- 1-3ä¸ªå·¥ä½œæ—¥

### 3.2 ç”³è¯·æ­¥éª¤

```
1. æ³¨å†Œå¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·
   https://open.weixin.qq.com
   
2. å®Œæˆå¼€å‘è€…èµ„è´¨è®¤è¯
   ä¸Šä¼ è¥ä¸šæ‰§ç…§ã€å¡«å†™ä¼ä¸šä¿¡æ¯
   
3. åˆ›å»ºç§»åŠ¨åº”ç”¨
   å¡«å†™APPä¿¡æ¯ã€å›¾æ ‡ã€ä»‹ç»
   
4. å¡«å†™Android/iOSåº”ç”¨åŒ…åå’Œç­¾å
   Android: com.yourcompany.borderbuddy
   iOS: Bundle Identifier
   
5. æäº¤å®¡æ ¸
   ç­‰å¾…1-3å¤©
   
6. è·å–AppIDå’ŒAppSecret
   å®¡æ ¸é€šè¿‡åå¯åœ¨åå°è·å–
```

### 3.3 å¿…å¤‡ä¿¡æ¯

**APPä¿¡æ¯ï¼š**
```
åº”ç”¨åç§°: é€šå…³åŠ©æ‰‹
åº”ç”¨ç®€ä»‹: æ™ºèƒ½å‡ºå…¥å¢ƒåŠ©æ‰‹ï¼ŒAIå¸®ä½ è¿‡æµ·å…³
åº”ç”¨å®˜ç½‘: https://yourapp.com
åº”ç”¨å›¾æ ‡: 1024x1024 PNG

åº”ç”¨åˆ†ç±»: æ—…æ¸¸å‡ºè¡Œ
```

**Androidä¿¡æ¯ï¼š**
```
åº”ç”¨åŒ…å: com.borderbuddy.app
åº”ç”¨ç­¾å: (ç”¨keytoolç”Ÿæˆ)

# ç”Ÿæˆç­¾åå‘½ä»¤
keytool -list -v -keystore your.keystore
```

**iOSä¿¡æ¯ï¼š**
```
Bundle ID: com.borderbuddy.app
Universal Links: https://yourapp.com/apple-app-site-association
```

---

## å››ã€æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 4.1 æŠ€æœ¯æ¶æ„

```
React Native APP
      â†“
react-native-wechat-lib (SDK)
      â†“
å¾®ä¿¡APP (ç”¨æˆ·æˆæƒ)
      â†“
è·å– code
      â†“
å‘é€åˆ°åç«¯ Cloudflare Worker
      â†“
ç”¨ code æ¢å– access_token + openid
      â†“
è·å–ç”¨æˆ·ä¿¡æ¯ (æ˜µç§°ã€å¤´åƒ)
      â†“
åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•
      â†“
è¿”å› JWT token
      â†“
APP ä¿å­˜ tokenï¼Œç™»å½•å®Œæˆ
```

### 4.2 å‰ç«¯å®ç°ï¼ˆReact Nativeï¼‰

**å®‰è£…ä¾èµ–ï¼š**
```bash
npm install react-native-wechat-lib
```

**é…ç½®å¾®ä¿¡SDKï¼š**
```javascript
// /src/services/wechat.js
import * as WeChat from 'react-native-wechat-lib';

// åˆå§‹åŒ–å¾®ä¿¡SDK
export async function initWechat() {
  try {
    await WeChat.registerApp(
      'wx1234567890abcdef', // ä½ çš„å¾®ä¿¡AppID
      'https://yourapp.com/' // Universal Link (iOS)
    );
    console.log('âœ… å¾®ä¿¡SDKåˆå§‹åŒ–æˆåŠŸ');
  } catch (error) {
    console.error('âŒ å¾®ä¿¡SDKåˆå§‹åŒ–å¤±è´¥', error);
  }
}

// æ£€æŸ¥å¾®ä¿¡æ˜¯å¦å®‰è£…
export async function isWechatInstalled() {
  return await WeChat.isWXAppInstalled();
}

// å¾®ä¿¡ç™»å½•
export async function loginWithWechat() {
  try {
    // 1. æ£€æŸ¥æ˜¯å¦å®‰è£…å¾®ä¿¡
    const installed = await isWechatInstalled();
    if (!installed) {
      throw new Error('æœªå®‰è£…å¾®ä¿¡ï¼Œè¯·ä½¿ç”¨æ‰‹æœºå·ç™»å½•');
    }

    // 2. å‘èµ·å¾®ä¿¡æˆæƒ
    const result = await WeChat.sendAuthRequest(
      'snsapi_userinfo', // è·å–ç”¨æˆ·ä¿¡æ¯æƒé™
      'wechat_login' // stateå‚æ•°ï¼Œç”¨äºé˜²CSRF
    );

    // 3. ç”¨æˆ·æˆæƒæˆåŠŸï¼Œè·å¾—code
    const { code } = result;
    console.log('âœ… è·å–åˆ°å¾®ä¿¡æˆæƒcode:', code);

    // 4. å‘é€codeåˆ°åç«¯ï¼Œæ¢å–ç”¨æˆ·ä¿¡æ¯
    const response = await fetch('https://your-worker.workers.dev/api/wechat-login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ code })
    });

    const data = await response.json();

    // 5. ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
    return {
      success: true,
      user: data.user,
      token: data.token
    };

  } catch (error) {
    console.error('âŒ å¾®ä¿¡ç™»å½•å¤±è´¥', error);
    return {
      success: false,
      error: error.message
    };
  }
}
```

**ç™»å½•ç•Œé¢ï¼š**
```javascript
// /screens/LoginScreen.jsx
import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, Image, StyleSheet } from 'react-native';
import { initWechat, loginWithWechat, isWechatInstalled } from '@/services/wechat';
import { useNavigation } from '@react-navigation/native';

export default function LoginScreen() {
  const [hasWechat, setHasWechat] = useState(false);
  const [loading, setLoading] = useState(false);
  const navigation = useNavigation();

  useEffect(() => {
    // åˆå§‹åŒ–å¾®ä¿¡SDK
    initWechat();
    
    // æ£€æŸ¥æ˜¯å¦å®‰è£…å¾®ä¿¡
    isWechatInstalled().then(setHasWechat);
  }, []);

  const handleWechatLogin = async () => {
    setLoading(true);
    
    const result = await loginWithWechat();
    
    if (result.success) {
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°å…¨å±€çŠ¶æ€
      // è·³è½¬åˆ°ä¸»é¡µ
      navigation.replace('Home');
    } else {
      alert(result.error);
    }
    
    setLoading(false);
  };

  const handlePhoneLogin = () => {
    // è·³è½¬åˆ°æ‰‹æœºå·ç™»å½•é¡µé¢
    navigation.navigate('PhoneLogin');
  };

  return (
    <View style={styles.container}>
      {/* Logo */}
      <Image 
        source={require('@/assets/logo.png')} 
        style={styles.logo}
      />
      
      <Text style={styles.title}>æ¬¢è¿ä½¿ç”¨é€šå…³åŠ©æ‰‹</Text>
      <Text style={styles.subtitle}>æ‰«ä¸€æ‰«è¯ä»¶ï¼ŒAIå¸®ä½ è¿‡æµ·å…³</Text>

      {/* å¾®ä¿¡ç™»å½•æŒ‰é’® */}
      {hasWechat && (
        <TouchableOpacity 
          style={styles.wechatButton}
          onPress={handleWechatLogin}
          disabled={loading}
        >
          <Image 
            source={require('@/assets/wechat-icon.png')} 
            style={styles.wechatIcon}
          />
          <Text style={styles.wechatButtonText}>
            {loading ? 'ç™»å½•ä¸­...' : 'å¾®ä¿¡ç™»å½•'}
          </Text>
        </TouchableOpacity>
      )}

      {/* åˆ†å‰²çº¿ */}
      <View style={styles.divider}>
        <View style={styles.dividerLine} />
        <Text style={styles.dividerText}>æˆ–</Text>
        <View style={styles.dividerLine} />
      </View>

      {/* æ‰‹æœºå·ç™»å½•æŒ‰é’® */}
      <TouchableOpacity 
        style={styles.phoneButton}
        onPress={handlePhoneLogin}
      >
        <Text style={styles.phoneButtonText}>æ‰‹æœºå·ç™»å½•</Text>
      </TouchableOpacity>

      {/* æç¤ºæ–‡å­— */}
      <Text style={styles.hint}>
        ç™»å½•å³è¡¨ç¤ºåŒæ„ 
        <Text style={styles.link}>ã€Šç”¨æˆ·åè®®ã€‹</Text>
        å’Œ
        <Text style={styles.link}>ã€Šéšç§æ”¿ç­–ã€‹</Text>
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#fff',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  logo: {
    width: 120,
    height: 120,
    marginBottom: 30,
  },
  title: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#000',
    marginBottom: 10,
  },
  subtitle: {
    fontSize: 16,
    color: '#666',
    marginBottom: 50,
  },
  wechatButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#07C160', // å¾®ä¿¡ç»¿
    paddingVertical: 15,
    paddingHorizontal: 60,
    borderRadius: 50,
    marginBottom: 20,
  },
  wechatIcon: {
    width: 24,
    height: 24,
    marginRight: 10,
  },
  wechatButtonText: {
    color: '#fff',
    fontSize: 18,
    fontWeight: '600',
  },
  divider: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 30,
    width: '80%',
  },
  dividerLine: {
    flex: 1,
    height: 1,
    backgroundColor: '#ddd',
  },
  dividerText: {
    marginHorizontal: 15,
    color: '#999',
    fontSize: 14,
  },
  phoneButton: {
    borderWidth: 1,
    borderColor: '#ddd',
    paddingVertical: 15,
    paddingHorizontal: 60,
    borderRadius: 50,
  },
  phoneButtonText: {
    color: '#333',
    fontSize: 16,
  },
  hint: {
    marginTop: 40,
    fontSize: 12,
    color: '#999',
    textAlign: 'center',
  },
  link: {
    color: '#0066CC',
  },
});
```

### 4.3 åç«¯å®ç°ï¼ˆCloudflare Workerï¼‰

**åˆ›å»º Workerï¼š**
```bash
wrangler init wechat-worker
```

**å®ç°ä»£ç ï¼š**
```javascript
// workers/wechat-login/index.js
// Cloudflare Worker for WeChat Login

export default {
  async fetch(request, env) {
    try {
      // 1. è·å–å‰ç«¯ä¼ æ¥çš„code
      const { code } = await request.json();

      if (!code) {
        return new Response(
          JSON.stringify({ error: 'ç¼ºå°‘codeå‚æ•°' }),
          { status: 400, headers: { 'Content-Type': 'application/json' } }
        );
      }

      // 2. ç”¨codeæ¢å–access_tokenå’Œopenid
      const tokenUrl = `https://api.weixin.qq.com/sns/oauth2/access_token?appid=${env.WECHAT_APP_ID}&secret=${env.WECHAT_APP_SECRET}&code=${code}&grant_type=authorization_code`;
      
      const tokenResponse = await fetch(tokenUrl);
      const tokenData = await tokenResponse.json();

      if (tokenData.errcode) {
        throw new Error(`å¾®ä¿¡APIé”™è¯¯: ${tokenData.errmsg}`);
      }

      const { access_token, openid } = tokenData;

      // 3. ç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯
      const userInfoUrl = `https://api.weixin.qq.com/sns/userinfo?access_token=${access_token}&openid=${openid}&lang=zh_CN`;
      
      const userInfoResponse = await fetch(userInfoUrl);
      const userInfo = await userInfoResponse.json();

      if (userInfo.errcode) {
        throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${userInfo.errmsg}`);
      }

      // 4. åœ¨Cloudflare D1æ•°æ®åº“ä¸­åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
      // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥å¾®ä¿¡ç”¨æˆ·
      const existingUser = await env.DB.prepare(
        'SELECT * FROM users WHERE wechat_openid = ?'
      ).bind(openid).first();

      let user;

      if (existingUser) {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        await env.DB.prepare(`
          UPDATE users 
          SET nickname = ?, avatar = ?, updated_at = ?
          WHERE wechat_openid = ?
        `).bind(
          userInfo.nickname,
          userInfo.headimgurl,
          new Date().toISOString(),
          openid
        ).run();
        
        user = await env.DB.prepare(
          'SELECT * FROM users WHERE wechat_openid = ?'
        ).bind(openid).first();
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·
        await env.DB.prepare(`
          INSERT INTO users (
            wechat_openid, wechat_unionid, nickname, avatar,
            gender, country, province, city, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          openid,
          userInfo.unionid || null,
          userInfo.nickname,
          userInfo.headimgurl,
          userInfo.sex, // 1=ç”·, 2=å¥³, 0=æœªçŸ¥
          userInfo.country,
          userInfo.province,
          userInfo.city,
          new Date().toISOString()
        ).run();
        
        user = await env.DB.prepare(
          'SELECT * FROM users WHERE wechat_openid = ?'
        ).bind(openid).first();
      }

      // 5. ç”ŸæˆJWT token (ä½¿ç”¨è‡ªå®šä¹‰JWTæˆ–ç¬¬ä¸‰æ–¹åº“)
      const token = await generateJWT(user, env.JWT_SECRET);

      // 6. è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œtoken
      return new Response(
        JSON.stringify({
          success: true,
          user: {
            id: user.id,
            nickname: user.nickname,
            avatar: user.avatar,
            openid: openid
          },
          token: token
        }),
        { 
          status: 200, 
          headers: { 'Content-Type': 'application/json' } 
        }
      );

    } catch (error) {
      console.error('å¾®ä¿¡ç™»å½•é”™è¯¯:', error);
      
      return new Response(
        JSON.stringify({ 
          success: false,
          error: error.message 
        }),
        { 
          status: 500, 
          headers: { 'Content-Type': 'application/json' } 
        }
      );
    }
  }
};

// JWTç”Ÿæˆå‡½æ•°(ç®€åŒ–ç‰ˆ,å®é™…ä½¿ç”¨è¯·ç”¨joseåº“)
async function generateJWT(user, secret) {
  // å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ jose æˆ–å…¶ä»–JWTåº“
  // npm install jose
  const jose = await import('jose');
  const jwt = await new jose.SignJWT({
    userId: user.id,
    openid: user.wechat_openid
  })
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(new TextEncoder().encode(secret));
  
  return jwt;
}
```

**é…ç½® wrangler.tomlï¼š**
```toml
name = "wechat-worker"
main = "src/index.js"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "trip-secretary"
database_id = "your-database-id"

[vars]
# è¿™äº›ä¸æ˜¯secret,å¯ä»¥å…¬å¼€
# WECHAT_APP_ID = "wx..." # é€šè¿‡ wrangler secret put è®¾ç½®

# Secret é€šè¿‡å‘½ä»¤è¡Œè®¾ç½®
# wrangler secret put WECHAT_APP_ID
# wrangler secret put WECHAT_APP_SECRET
# wrangler secret put JWT_SECRET
```

**è®¾ç½®ç¯å¢ƒå˜é‡ï¼š**
```bash
wrangler secret put WECHAT_APP_ID
# è¾“å…¥: wx1234567890abcdef

wrangler secret put WECHAT_APP_SECRET
# è¾“å…¥: your_app_secret_here

wrangler secret put JWT_SECRET
# è¾“å…¥: your_jwt_secret_here
```

### 4.4 æ•°æ®åº“Schemaæ›´æ–°

```sql
-- Cloudflare D1 è¡¨ç»“æ„ (SQLiteè¯­æ³•)
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  wechat_openid TEXT UNIQUE NOT NULL,
  wechat_unionid TEXT,
  nickname TEXT,
  avatar TEXT,
  gender INTEGER DEFAULT 0, -- 0=æœªçŸ¥, 1=ç”·, 2=å¥³
  country TEXT,
  province TEXT,
  city TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_users_wechat_openid ON users(wechat_openid);
CREATE INDEX IF NOT EXISTS idx_users_wechat_unionid ON users(wechat_unionid);

-- éƒ¨ç½²åˆ°D1
-- wrangler d1 execute trip-secretary --file=./migrations/001_users.sql
```

---

## äº”ã€iOSé…ç½®ï¼ˆé‡è¦ï¼‰

### 5.1 é…ç½®Universal Links

**ä¸ºä»€ä¹ˆéœ€è¦ï¼š**
- iOS 9+ è¦æ±‚ä½¿ç”¨Universal Links
- å¾®ä¿¡ç™»å½•åéœ€è¦è·³å›ä½ çš„APP

**æ­¥éª¤ï¼š**

1. **åœ¨ä½ çš„åŸŸåæ ¹ç›®å½•æ”¾ç½®æ–‡ä»¶ï¼š**
   ```
   https://yourapp.com/.well-known/apple-app-site-association
   ```

2. **æ–‡ä»¶å†…å®¹ï¼š**
   ```json
   {
     "applinks": {
       "apps": [],
       "details": [
         {
           "appID": "TEAM_ID.com.borderbuddy.app",
           "paths": [
             "/wechat/*"
           ]
         }
       ]
     }
   }
   ```

3. **åœ¨Xcodeä¸­é…ç½®ï¼š**
   - Signing & Capabilities
   - æ·»åŠ  Associated Domains
   - æ·»åŠ ï¼š`applinks:yourapp.com`

4. **åœ¨Info.plistä¸­æ·»åŠ ï¼š**
   ```xml
   <key>LSApplicationQueriesSchemes</key>
   <array>
     <string>wechat</string>
     <string>weixin</string>
     <string>weixinULAPI</string>
   </array>
   ```

5. **åœ¨AppDelegateä¸­å¤„ç†Universal Linksï¼š**
   ```swift
   func application(_ application: UIApplication, 
                    continue userActivity: NSUserActivity,
                    restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
     return WXApi.handleOpenUniversalLink(userActivity, delegate: self)
   }
   ```

---

## å…­ã€Androidé…ç½®

### 6.1 AndroidManifest.xml

```xml
<manifest>
  <application>
    <!-- å¾®ä¿¡ç™»å½•å›è°ƒ -->
    <activity
      android:name=".wxapi.WXEntryActivity"
      android:label="@string/app_name"
      android:exported="true"
      android:taskAffinity="com.borderbuddy.app"
      android:launchMode="singleTask">
    </activity>
  </application>
  
  <!-- å¾®ä¿¡æƒé™ -->
  <queries>
    <package android:name="com.tencent.mm" />
  </queries>
</manifest>
```

### 6.2 åˆ›å»ºWXEntryActivity

```kotlin
// android/app/src/main/java/com/borderbuddy/app/wxapi/WXEntryActivity.kt
package com.borderbuddy.app.wxapi

import android.app.Activity
import android.os.Bundle
import com.theweflex.react.WeChatModule

class WXEntryActivity : Activity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    WeChatModule.handleIntent(intent)
    finish()
  }
}
```

---

## ä¸ƒã€æµ‹è¯•æµç¨‹

### 7.1 å¼€å‘ç¯å¢ƒæµ‹è¯•

```bash
# 1. å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨
npm start

# 2. åœ¨çœŸæœºä¸Šæµ‹è¯•ï¼ˆä¸èƒ½ç”¨æ¨¡æ‹Ÿå™¨ï¼‰
# å¾®ä¿¡ç™»å½•å¿…é¡»åœ¨çœŸæœºä¸Šæµ‹è¯•

# 3. ç‚¹å‡»å¾®ä¿¡ç™»å½•æŒ‰é’®
# è§‚å¯Ÿconsoleæ—¥å¿—

# 4. æˆæƒååº”è¯¥èƒ½çœ‹åˆ°ï¼š
# âœ… è·å–åˆ°code
# âœ… åç«¯è¿”å›ç”¨æˆ·ä¿¡æ¯
# âœ… è·³è½¬åˆ°é¦–é¡µ
```

### 7.2 å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1: æç¤º"æœªå®‰è£…å¾®ä¿¡"**
- æ£€æŸ¥ï¼šçœŸçš„å®‰è£…äº†å¾®ä¿¡å—ï¼Ÿ
- æ£€æŸ¥ï¼šAndroidManifest.xml ä¸­çš„ queries é…ç½®

**é—®é¢˜2: ç‚¹å‡»å¾®ä¿¡ç™»å½•æ— ååº”**
- æ£€æŸ¥ï¼šAppIDæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ï¼šåº”ç”¨æ˜¯å¦å·²é€šè¿‡å¾®ä¿¡å®¡æ ¸
- æ£€æŸ¥ï¼šåº”ç”¨ç­¾åæ˜¯å¦åŒ¹é…

**é—®é¢˜3: æˆæƒåæ— æ³•è¿”å›APP**
- iOS: æ£€æŸ¥Universal Linksé…ç½®
- Android: æ£€æŸ¥WXEntryActivityé…ç½®

**é—®é¢˜4: åç«¯æŠ¥é”™"invalid code"**
- codeåªèƒ½ä½¿ç”¨ä¸€æ¬¡
- codeæœ‰æ•ˆæœŸ5åˆ†é’Ÿ
- æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®

---

## å…«ã€ç”¨æˆ·éšç§å’Œåˆè§„

### 8.1 å¿…é¡»å‘ŠçŸ¥ç”¨æˆ·

```
ç™»å½•å³è¡¨ç¤ºåŒæ„ï¼š

1. æˆ‘ä»¬å°†è·å–æ‚¨çš„å¾®ä¿¡æ˜µç§°å’Œå¤´åƒ
2. æˆ‘ä»¬ä¸ä¼šè·å–æ‚¨çš„å¾®ä¿¡å¥½å‹åˆ—è¡¨
3. æˆ‘ä»¬ä¸ä¼šå‘æ‚¨çš„å¾®ä¿¡å¥½å‹å‘é€æ¶ˆæ¯
4. æ‚¨çš„è¯ä»¶ä¿¡æ¯ä»…ç”¨äºç”Ÿæˆå…¥å¢ƒææ–™
5. æ‰€æœ‰æ•°æ®åŠ å¯†å­˜å‚¨
```

### 8.2 éšç§æ”¿ç­–å¿…é¡»åŒ…å«

- æ”¶é›†å“ªäº›å¾®ä¿¡ä¿¡æ¯
- ä¿¡æ¯ç”¨äºä»€ä¹ˆç›®çš„
- æ˜¯å¦åˆ†äº«ç»™ç¬¬ä¸‰æ–¹
- ç”¨æˆ·å¦‚ä½•åˆ é™¤æ•°æ®
- è”ç³»æ–¹å¼

---

## ä¹ã€æˆæœ¬åˆ†æ

### 9.1 å¾®ä¿¡ç™»å½•æˆæœ¬

**å¼€å‘æˆæœ¬ï¼š**
- å¾®ä¿¡å¼€æ”¾å¹³å°è®¤è¯: Â¥300/å¹´
- å¼€å‘æ—¶é—´: 2-3å¤©

**è¿è¥æˆæœ¬ï¼š**
- APIè°ƒç”¨: å…è´¹
- æœåŠ¡å™¨: Supabaseå…è´¹é¢åº¦å†…

**æ€»ç»“ï¼šéå¸¸ä¾¿å®œï¼** âœ…

---

## åã€é™çº§æ–¹æ¡ˆ

### 10.1 å¦‚æœç”¨æˆ·æ²¡æœ‰å¾®ä¿¡

```javascript
// æ£€æµ‹å¾®ä¿¡å¹¶æä¾›é™çº§é€‰é¡¹
const handleLogin = async () => {
  const hasWechat = await isWechatInstalled();
  
  if (!hasWechat) {
    // æç¤ºç”¨æˆ·ä½¿ç”¨æ‰‹æœºå·ç™»å½•
    Alert.alert(
      'æœªå®‰è£…å¾®ä¿¡',
      'æ‚¨å¯ä»¥ä½¿ç”¨æ‰‹æœºå·ç™»å½•',
      [
        { text: 'ä½¿ç”¨æ‰‹æœºå·', onPress: () => navigation.navigate('PhoneLogin') },
        { text: 'å–æ¶ˆ', style: 'cancel' }
      ]
    );
    return;
  }
  
  // ç»§ç»­å¾®ä¿¡ç™»å½•æµç¨‹
  await loginWithWechat();
};
```

### 10.2 å›½äº§æ‰‹æœºç”¨æˆ·ï¼ˆé‡è¦ï¼‰â­

**ç°å®æƒ…å†µï¼š**
- åä¸ºã€å°ç±³ã€OPPOã€vivoç­‰å›½äº§æ‰‹æœº
- å¯èƒ½æ²¡æœ‰é¢„è£…Google Play Services
- ä½†100%éƒ½æœ‰å¾®ä¿¡

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾®ä¿¡ç™»å½•æœ€é€‚åˆï¼š**
- âœ… ä¸ä¾èµ–GoogleæœåŠ¡
- âœ… çº¯å›½äº§æŠ€æœ¯æ ˆ
- âœ… åä¸ºé¸¿è’™ç³»ç»Ÿä¹Ÿæ”¯æŒ
- âœ… æ‰€æœ‰Androidæ‰‹æœºéƒ½èƒ½ç”¨

### 10.3 é¦™æ¸¯ç”¨æˆ·è€ƒè™‘

**é—®é¢˜ï¼šé¦™æ¸¯ç”¨æˆ·å¯èƒ½ä¸å¸¸ç”¨å¾®ä¿¡**

**è§£å†³æ–¹æ¡ˆï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é€‰æ‹©ç™»å½•æ–¹å¼              â”‚
â”‚                             â”‚
â”‚  [ğŸ’¬ å¾®ä¿¡ç™»å½•]  (å¤§é™†ç”¨æˆ·æ¨è)â”‚
â”‚                             â”‚
â”‚  [ğŸ“± æ‰‹æœºå·ç™»å½•] (é¦™æ¸¯ç”¨æˆ·æ¨è)â”‚
â”‚                             â”‚
â”‚  [ğŸ Apple IDç™»å½•] (iOS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ™ºèƒ½æ¨èï¼š**
```javascript
// æ ¹æ®æ‰‹æœºç³»ç»Ÿè¯­è¨€è‡ªåŠ¨æ¨è
const recommendLoginMethod = () => {
  const locale = NativeModules.I18nManager.localeIdentifier;
  
  if (locale.includes('zh_CN')) {
    // å¤§é™†ç”¨æˆ· - æ¨èå¾®ä¿¡
    return 'wechat';
  } else if (locale.includes('zh_HK') || locale.includes('zh_TW')) {
    // æ¸¯å°ç”¨æˆ· - æ¨èæ‰‹æœºå·
    return 'phone';
  }
  
  return 'phone'; // é»˜è®¤
};
```

---

## åä¸€ã€å¼€å‘æ—¶é—´è¡¨

### Week 1: å‡†å¤‡å·¥ä½œ
- Day 1-2: ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·
- Day 3-4: ç­‰å¾…å®¡æ ¸
- Day 5: è·å–AppIDå’ŒSecret

### Week 2: å¼€å‘é›†æˆ
- Day 1-2: å‰ç«¯é›†æˆreact-native-wechat-lib
- Day 3-4: åç«¯å®ç°Supabase Edge Function
- Day 5: iOS/Androidé…ç½®

### Week 3: æµ‹è¯•ä¸Šçº¿
- Day 1-3: çœŸæœºæµ‹è¯•
- Day 4-5: ä¿®å¤bugï¼Œå‡†å¤‡ä¸Šçº¿

---

## åäºŒã€åç»­ä¼˜åŒ–

### V1.0ï¼ˆMVPï¼‰
- âœ… å¾®ä¿¡ç™»å½•
- âœ… æ‰‹æœºå·ç™»å½•ï¼ˆå¤‡é€‰ï¼‰

### V2.0ï¼ˆæœªæ¥ï¼‰
- æ”¯ä»˜å®ç™»å½•ï¼ˆæ”¯ä»˜åœºæ™¯ï¼‰
- QQç™»å½•ï¼ˆå¯é€‰ï¼‰
- å¾®ä¿¡å°ç¨‹åºç‰ˆæœ¬
- UnionIDæ”¯æŒï¼ˆå¤šåº”ç”¨è´¦å·äº’é€šï¼‰

---

## æ€»ç»“

âœ… **å¾®ä¿¡ç™»å½•æ˜¯æœ€ä½³é€‰æ‹©**
- è¦†ç›–13äº¿ç”¨æˆ·
- ä¸­è€å¹´å‹å¥½
- å…è´¹ä½¿ç”¨
- å®‰å…¨å¯é 

âœ… **ç‰¹åˆ«é€‚åˆå›½äº§æ‰‹æœº**
- åä¸ºã€å°ç±³ã€OPPOã€vivo 100%æ”¯æŒ
- ä¸ä¾èµ–GoogleæœåŠ¡
- åä¸ºé¸¿è’™ç³»ç»Ÿä¹Ÿèƒ½ç”¨
- æ¯”Apple IDè¦†ç›–é¢æ›´å¹¿

âœ… **é…åˆæ‰‹æœºå·ç™»å½•**
- é¦™æ¸¯ç”¨æˆ·å¤‡é€‰
- æ²¡å®‰è£…å¾®ä¿¡çš„ç”¨æˆ·ï¼ˆæå°‘ï¼‰

âœ… **å¼€å‘æˆæœ¬ä½**
- è®¤è¯è´¹ Â¥300/å¹´
- å¼€å‘æ—¶é—´ 2-3å¤©
- è¿è¥æˆæœ¬å‡ ä¹ä¸º0

ğŸš€ **å¯ä»¥å¼€å§‹å¼€å‘äº†ï¼**

---

## é™„å½•ï¼šå›½äº§æ‰‹æœºå¸‚åœºä»½é¢ï¼ˆ2025ï¼‰

| å“ç‰Œ | å¸‚åœºä»½é¢ | å¾®ä¿¡æ”¯æŒ | GoogleæœåŠ¡ |
|------|---------|---------|-----------|
| åä¸º | 23% | âœ… | âŒ (HMS) |
| å°ç±³ | 18% | âœ… | âœ… |
| OPPO | 16% | âœ… | âœ… |
| vivo | 15% | âœ… | âœ… |
| è£è€€ | 12% | âœ… | âœ… |
| Apple | 16% | âœ… | âœ… |

**å…³é”®å‘ç°ï¼š**
- 84%çš„æ‰‹æœºæ˜¯å›½äº§å“ç‰Œ
- 100%çš„æ‰‹æœºæ”¯æŒå¾®ä¿¡
- åªæœ‰23%çš„æ‰‹æœºï¼ˆåä¸ºï¼‰æ²¡æœ‰GoogleæœåŠ¡
- **ç»“è®ºï¼šå¾®ä¿¡ç™»å½•æ˜¯å”¯ä¸€èƒ½è¦†ç›–æ‰€æœ‰ç”¨æˆ·çš„æ–¹æ¡ˆ**

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-06-01  

---

END OF DOCUMENT
